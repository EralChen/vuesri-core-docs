import{a1 as w,a2 as O,a4 as N,a5 as Y,mq as ie,eY as ae,bI as M,d4 as K,aA as L,sQ as oe,jm as de,Bd as ce,Be as le,Bf as ue,dH as he,s as me,a_ as G,dk as fe,Bg as pe,Bh as _e,ns as ge,Bi as we,ht as A,Bj as ye,nn as Ie,bq as p,q7 as be,Bk as Re,bt as ve,cz as xe,tN as Ce,b5 as Te,Ad as Ee,Bl as Oe,Bm as Ae,cQ as Se,gI as $e,nk as U,gH as Fe,Bn as Be,nr as Me,zg as De,Bo as Ne,vQ as Ge,br as I,o_ as je,aO as J,as as q,an as ke,a0 as Le}from"./chunk-CMhy9c9G.js";import{V as Pe}from"./chunk-Dcn2W9Gp.js";import{h as Qe,E as ee}from"./chunk-_StMwdLk.js";import{n as We}from"./chunk-CvgiXnaQ.js";import"./chunk-ByM7454y.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-DcUppS74.js";import"./chunk-YA9YD_OS.js";import"./chunk-D1fDIYeK.js";import"./chunk-O5eRSE6e.js";let b=class extends Y{constructor(e){super(e),this._removing=0,this._tiles=new ie}destroy(){for(const e of this._tiles.values())e.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(const e of this._tiles.values())if(!e.finished)return!0;return!1}async onTileTreeChange(e){const{added:t,removed:n}=e,s=this._tiles,i=[];for(const a of n){const o=s.get(a);o!=null&&(o.abort(),s.delete(a),i.push({tileId:a}))}for(const a of t)s.has(a.id)||s.set(a.id,ae(o=>this._addTile(a,o)));await this._removeTiles(i)}async _addTile(e,t){const n=await this.addTile(e,t);return M(t),n}async _removeTiles(e){this._removing++,await this.removeTiles(e),this._removing--}};w([O()],b.prototype,"updating",null),w([O({constructOnly:!0})],b.prototype,"addTile",void 0),w([O({constructOnly:!0})],b.prototype,"removeTiles",void 0),w([O()],b.prototype,"_removing",void 0),b=w([N("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],b);let P=class{constructor(e,t){this._index=e,this._view=t}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new ze(this._index,this._view,e)}},ze=class extends P{constructor(e,t,n){super(e,t),this._geometryOverride=n}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return We(new L,this._geometryOverride,e.hasZ,e.hasM)}},Ye=class{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new K,this.featureAdapter=Q.shared}addTile(e){this._storedTiles.set(e.descriptor.id,e);for(const t of e.pages)this._addPage(t)}removeTile(e){const t=this._storedTiles,n=t.get(e);if(n!=null){t.delete(e);for(const s of n.pages)this._removePage(s)}}_addPage(e){const{featureCount:t}=e;if(t===0)return;const n=new Qe(9,i=>e.getBounds(i)),s=new Array;for(let i=0;i<t;++i)s[i]=i;n.load(s),this._pageBounds.set(e,n),this.events.emit("changed")}_removePage(e){this._pageBounds.delete(e),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,n]of this._pageBounds)n.all(s=>e(new P(s,t)))}forEachInBounds(e,t){E.minX=e[0],E.minY=e[1],E.maxX=e[2],E.maxY=e[3];for(const[n,s]of this._pageBounds)s.search(E,i=>t(new P(i,n)))}forEachBounds(e,t){for(const n of e)t(n.getBoundingBox())}getFullExtent(e){let t=1/0,n=1/0,s=-1/0,i=-1/0;for(const a of this._pageBounds.values()){const{minX:o,minY:c,maxX:u,maxY:l}=a.toJSON();t=Math.min(t,o),n=Math.min(n,c),s=Math.min(s,u),i=Math.min(i,l)}return{xmin:t,ymin:n,xmax:s,ymax:i,spatialReference:e}}},Q=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};Q.shared=new Q;const E=new ee;let Ue=class{constructor(e,t){this.descriptor=e,this.pages=t}};class Je{constructor(e){const t=new oe(new Uint8Array(e),new DataView(e));this._reader=t,this._index=qe(t)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:n,attributeIndices:s}}=this,i=n.get(t)?.index;if(i==null)return;const a=s[e*n.fields.length+i],o=this._reader;return o.move(a),k(o)}getAttributeAsTimestamp(e,t){const n=this.getAttribute(e,t);return typeof n=="string"?new Date(n).getTime():typeof n=="number"||n==null?n:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:n}}=this,s=e*t.fields.length,i=this._reader,a={};for(const o of t.fields){const c=n[s+o.index];i.move(c),a[o.name]=k(i)}return a}getCoordinates(e,t,n=0){const s=this._reader,{transform:i,featureIndices:a}=this._index,{scale:o,translate:c}=i;s.move(a[e]),this._readCoordinates(o,c,t,n)}getOptimizedGeometry(e){const t=G();return this.getCoordinates(e,t),new L([],t)}getCentroid(e,{hasZ:t,hasM:n}){this.getCoordinates(e,C);const[s,i,a]=C,o=[s,i];return t&&(o[3]=a),n&&(o[t?4:3]=0),new L([],o)}getBounds(e){this.getCoordinates(e,C);const[t,n]=C,s=new ee;return s.minX=t,s.minY=n,s.maxX=t,s.maxY=n,s}getBoundingBox(e){this.getCoordinates(e,C);const[t,n,s]=C;return de(t,n,s,t,n,s)}readAllObjectIds(e,t=0){const n=this._reader,{_index:s,featureCount:i}=this,{objectIdFieldName:a,attributeIndices:o,fieldsIndex:c}=s,u=c.get(a).index,l=c.fields.length;for(let d=0;d<i;++d){const h=o[d*l+u];n.move(h),e[t++]=k(n)}return t}readAllCoordinates(e,t=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:a,translate:o}=s;for(const c of i)n.move(c),t=this._readCoordinates(a,o,e,t);return t}_readCoordinates([e,t,n],[s,i,a],o,c){const d=this._reader,h=d.getLength(),m=d.pos()+h;for(;d.pos()<m&&d.next();)switch(d.tag()){case 2:{const g=d.getLength(),_=d.pos()+g;for(;d.pos()<_&&d.next();)d.tag()===3?(d.getUInt32(),o[c++]=s+e*d.getSInt64(),o[c++]=i+t*d.getSInt64(),o[c++]=a+n*d.getSInt64()):d.skip();break}default:d.skip()}return c}}function qe(r){for(;r.next();){if(r.tag()===2)return Ve(r.getMessage());r.skip()}D()}function Ve(r){for(;r.next();){if(r.tag()===1)return He(r.getMessage());r.skip()}D()}function He(r){let l,d,h=!1,m=!1,g=0;const _=new Array,R=new Array,v=new Array;for(;r.next();)switch(r.tag()){case 1:d=r.getString();break;case 7:r.getEnum()!==0&&D();break;case 9:h=r.getBool()??!1;break;case 12:l=le(r.processMessage(ue));break;case 13:{const x=r.processMessage(ce);x.index=g++,_.push(x);break}case 15:{R.push(r.pos());const x=r.getUInt32(),j=r.pos()+x;for(;r.pos()<j&&r.next();)r.tag()===1&&v.push(r.pos()),r.skip();break}case 10:m=r.getBool()??!1;break;default:r.skip()}const S=new he(_);return l!=null&&m&&d!=null&&S.has(d)||D(),{transform:l,exceededTransferLimit:h,fieldsIndex:S,objectIdFieldName:d,featureIndices:R,attributeIndices:v}}function D(){const r=new me("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(r),r}function k(r){const l=r.getLength(),d=r.pos()+l;for(;r.pos()<d&&r.next();)switch(r.tag()){case 1:return r.getString();case 2:return r.getFloat();case 3:return r.getDouble();case 4:return r.getSInt32();case 5:return r.getUInt32();case 6:return r.getInt64();case 7:return r.getUInt64();case 8:return r.getSInt64();case 9:return r.getBool();default:return r.skip(),null}return null}const C=G(),V=8e3,Xe=4,Ze=4;let Ke=class{constructor(e,t,n,s,i){this.spatialReference=e,this.url=n,this.objectIdField=s,this.capabilities=i;const{supportsMaxRecordCountFactor:a,maxRecordCount:o}=this.capabilities.query,c=a?Xe:1,u=(o??V)*c;this._pageSize=Math.min(V,u);const l=t.clone();l.cacheHint=!0,l.resultType="tile",l.outSpatialReference=e,l.returnGeometry=!0,l.returnZ=!0,l.maxRecordCountFactor=c,l.num=this._pageSize,l.outFields=[s],this._baseQuery=l}async fetch(e,t){const{spatialReference:n}=this,s=fe(e.extent,n),i=this._baseQuery.clone();i.geometry=s;const a=new Array;let o=0,c=!1,u=1;for(;!c;){const l=[];for(let h=0;h<u;++h)l.push(this._fetchPage(i,o++,t));const d=await Promise.all(l);M(t);for(const h of d){const m=h.featureCount!==0;c||=!h.exceededTransferLimit||!m,m&&a.push(h)}u=Math.min(u+1,Ze)}return new Ue(e,a)}async _fetchPage(e,t,n){const s=e.clone();s.start=t*this._pageSize;const i=(await pe(this.url,s,{signal:n})).data;return M(n),new Je(i)}},H=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const n=this._bufferWriter;let s=null;if(e.transformation&&t)_e(T,e.transformation),T[12]-=t[0],T[13]-=t[1],T[14]-=t[2],s=T;else{if(t)throw new Error("not implemented");e.transformation&&(s=e.transformation)}let i=null;s&&(ge($,T),we($,$),i=$);const a=e.attributes,o=n.elementCount(a),c=n.vertexBufferLayout.stride/4;o>Math.floor(et/c)&&console.warn("geometry with very large number of elements encountered");const u=n.vertexBufferLayout.createBuffer(o);return n.write(s,i,a,e.objectAndLayerIdColor,u,0),{data:u.buffer,elementCount:o}}};const T=A(),$=A(),et=16777216/4;class tt{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,n=t.generateId("material");switch(e){case"default":{const s=new Ie({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new H(s);t.registerRenderGeometryBufferWriter(n,i)}break;case"hud":{const s=ye(null,this._context.globalViewingMode)[0],i=new H(s);t.registerRenderGeometryBufferWriter(n,i)}}return this._commands.push({id:"create-material",type:e,materialId:n}),n}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,n){const s=t.materialId,i=this._context.getRenderGeometryBufferWriter(s);if(i==null)throw new Error(`no bufferwriter found for material ${s}`);const a=i.createBuffer(t,n);this._transferables.add(a.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:s,renderGeometryBuffer:a,localOrigin:n})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),n={levels:e.levels.map(s=>({components:s.components.map(i=>{const a=i.attributes.get(p.POSITION);if(!a||a.indices.length===0)throw new Error("positions attribute expected");const o=3,c=be(a.indices.length/o),u=new Re(c,o,a),l=this._context.getRenderGeometryBufferWriter(i.materialId);if(l==null)throw new Error("writer not found");const d=l.createBuffer(i,null);return this._transferables.add(d.data),{materialId:i.materialId,renderGeometryBuffer:d,boundingInfo:{bbMax:u.bbMax,bbMin:u.bbMin}}}),minScreenSpaceRadius:s.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:n}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}class rt{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===ve.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new tt(this)}async dispatchRenderCommands(e,t){this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}var f;(function(r){r[r.OBJECT_ID=0]="OBJECT_ID",r[r.PARTITION_ID=1]="PARTITION_ID",r[r.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",r[r.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",r[r.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"})(f||(f={}));async function nt(r,e){const{numFeatures:t,tile:n,partitionInfo:s}=r,{pages:i}=n;if(i.length===0||t===0)return new Uint32Array;const a=new Uint32Array(t);if(s){const o=i.reduce((d,{featureCount:h})=>d+h,0),c=new Uint32Array(o);let u=0;for(const d of i)u=d.readAllObjectIds(c,u);const l=s.tileIndices;for(let d=0;d<t;++d){const h=c[l[d]];a[d]=h}}else{let o=0;for(const c of i)o=c.readAllObjectIds(a,o)}return a}async function st(r,e){const{numFeatures:t,tile:n,partitionInfo:s}=r,{pages:i}=n;if(i.length===0||t===0)return new Float64Array;const a=new Float64Array(3*t);if(s){const o=i.reduce((d,{featureCount:h})=>d+h,0),c=new Float64Array(3*o);let u=0;for(const d of i)u=d.readAllCoordinates(c,u);const l=s.tileIndices;for(let d=0;d<t;++d){const h=l[d],m=c[3*h+0],g=c[3*h+1],_=c[3*h+2];a[3*d+0]=m,a[3*d+1]=g,a[3*d+2]=_}}else{let o=0;for(const c of i)o=c.readAllCoordinates(a,o)}return a}async function it(r,e){await r.provision([f.GEOMETRY_MAP_COORDINATES],e);const{numFeatures:t,tile:n,mapCoordinates:s}=r,{pages:i}=n;if(i.length===0||t===0)return new Float64Array;const a=e.viewSpatialReference,o=e.renderSpatialReference,c=new Float64Array(3*t);if(!xe(s,a,0,c,o,0,t))throw new Error("Failed to project coordinates");return c}async function at(r,e){const t=e.viewSpatialReference,n=e.renderSpatialReference,s=r.tile.descriptor.extent,i=Ce(s),a=G();return Te([i[0],i[1],0],t,a,n),a}let te=class{constructor(e,t,n=null){this._tile=e,this._numFeatures=t,this._partitionInfo=n}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(this._objectIds==null)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(this._partitionIds==null)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(this._mapCoordinates==null)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(this._renderCoordinates==null)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(this._tileCenterRenderCoordinates==null)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}async provision(e,t){for(const n of e)switch(n){case f.OBJECT_ID:if(this._objectIds)return;this._objectIds=await nt(this);break;case f.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case f.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=await st(this);break;case f.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=await it(this,t);break;case f.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=await at(this,t);break;default:throw new Error("not implemented")}}dispose(){if(this.partitions){for(const e of this.partitions)e.dispose();this.partitions=void 0}}};function re(r){const e=new Map;for(const[t,n]of r)e.set(t,{...n,indices:Ee(n.indices)});return e}function ot(r,e){const t=(n,s,i=!1)=>({levels:n.map(a=>{const o=re(s(a.tesselation));return i&&dt(o),{components:[{attributes:o,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:a.minScreenSpaceRadius}})});switch(r){case"cone":return t(ct,n=>Oe(1,.5,n,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function dt(r){const e=r,t=e.get(p.POSITION).data,n=e.get(p.NORMAL).data;if(n){const s=X(r,p.NORMAL).data;for(let i=0;i<n.length;i+=3){const a=n[i+1];s[i+1]=-n[i+2],s[i+2]=a}}if(t){const s=X(r,p.POSITION).data;for(let i=0;i<t.length;i+=3){const a=t[i+1];s[i+1]=-t[i+2],s[i+2]=a}}}function X(r,e){let t=r.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:Ae(t.data)},r.set(e,t)),t}const ct=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let W=class extends Y{constructor(r){super(),this._context=r,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}async load(r){const e=r.createMaterial("default"),t=ot("cone",e);this.lodRendererId=r.createLodRenderer(t),this._loaded=!0}async add(r,e){if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");await this._provisionFeatureData(r);const t=r.numFeatures,n=!0,s=Se($e("cone")),i=U(Fe(s)),a=U(Be(i,{isPrimitive:n,width:100,depth:null,height:null})),o=new Float64Array(16*t),c=new Float64Array(16*t),u=r.mapCoordinates;for(let d=0;d<t;++d){const h=d,m=u[3*d+0],g=u[3*d+1],_=u[3*d+2],R=this._computeGlobalTransform(m,g,_,this._context.viewSpatialReference,ut),v=this._computeLocalTransform(a,i,lt);this._writeMatrixToTypedBuffer(o,h,v),this._writeMatrixToTypedBuffer(c,h,R)}const l={featureIds:new Uint32Array(r.objectIds),localTransforms:o,globalTransforms:c};e.addLodInstances(this.lodRendererId,l)}async remove(r,e){if(this.lodRendererId==null)return;const t=new Uint32Array(r.objectIds);e.removeLodInstances(this.lodRendererId,t)}async _provisionFeatureData(r){await r.provision([f.GEOMETRY_MAP_COORDINATES,f.OBJECT_ID],this._context)}_writeMatrixToTypedBuffer(r,e,t){let n=16*e;for(let s=0;s<16;s++)r[n++]=t[s]}_computeGlobalTransform(r,e,t,n,s){return F[0]=r,F[1]=e,F[2]=t,Me(n,F,s,this._context.renderSpatialReference),s}_computeLocalTransform(r,e,t){return De(t),this._applyObjectScale(r,e,t),t}_applyObjectScale(r,e,t){const n=Ne(r,r,e,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||Ge(t,t,n)}};W=w([N("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],W);const F=G(),lt=A(),ut=A();let z=class extends Y{constructor(r){super(),this._context=r,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}async load(r){this.materialId=r.createMaterial("hud"),r.createDirectRenderer(this.materialId),this._loaded=!0}async add(r,e){if(this.materialId==null)throw new Error("expected material not to be null");await this._provisionFeatureData(r);const{numFeatures:t,tileId:n,renderCoordinates:s,tileCenterRenderCoordinates:i}=r,a=new Float64Array([0,0,1]),o=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),u=new Float64Array([0,0,0,1]),l=new Float64Array([0,0]),d=new Float64Array([0]),h=new Uint32Array(t);for(let y=0;y<t;++y)h[y]=y;const m=new Uint32Array(t);for(let y=0;y<t;++y)m[y]=0;const g=new I(s,h,3,!0),_=new I(a,m,3,!0),R=new I(l,m,2,!0),v=new I(o,m,4,!0),S=new I(d,m,1,!0),x=new I(c,m,2,!0),j=new I(u,m,4,!0),ne=[[p.POSITION,g],[p.NORMAL,_],[p.UV0,R],[p.COLOR,v],[p.ROTATION,S],[p.SIZE,x],[p.CENTEROFFSETANDDISTANCE,j]],se={attributes:re(ne),objectAndLayerIdColor:void 0,transformation:A(),materialId:this.materialId};e.addDirectRendererGeometry(n,se,i)}async remove(r,e){e.removeDirectRendererGeometry(r.tileId)}async _provisionFeatureData(r){await r.provision([f.GEOMETRY_RENDER_COORDINATES,f.TILE_CENTER_RENDER_COORDINATES],this._context)}};z=w([N("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],z);class ht{constructor(e){this._symbols=new Map,this._context=e}async load(){this._symbols.set(0,new z(this._context)),this._symbols.set(1,new W(this._context))}async add(e,t){await this._provisionFeatureData(e,this._context);const n=this._partition(e);await Promise.all(n.map(async s=>{const i=await this._provisionSymbol(s.partitionInfo?.index,t);i&&await i.add(s,t)}))}async remove(e,t){const n=e.partitions;if(!n)throw new Error("partitioned featureset expected");await Promise.all(n.map(async s=>{const i=await this._provisionSymbol(s.partitionInfo?.index,t);i&&await i.remove(s,t)}))}async _provisionFeatureData(e,t){await e.provision([f.PARTITION_ID,f.OBJECT_ID],t)}async _provisionSymbol(e,t){if(e==null)return null;const n=this._symbols.get(e);return n?(n.loaded||await n.load(t),n):null}_partition(e){const{numFeatures:t,objectIds:n,partitionIds:s}=e,i=[[],[]];for(let a=0;a<t;++a){const o=n[a]%2;i[o].push(a),s[a]=o}return e.partitions=i.filter(a=>a.length>0).map((a,o)=>{const c=a.length,u={index:o,tileIndices:new Uint32Array(a)};return new te(e.tile,c,u)}),e.partitions}}class mt{constructor(e){this._tileFeatureData=new Map,this._context={viewSpatialReference:e.viewSpatialReference,renderSpatialReference:e.renderSpatialReference,renderCoordsHelper:je.create(e.viewingMode,e.renderSpatialReference)}}async add(e,t){this._featureRenderer||(this._featureRenderer=new ht(this._context),await this._featureRenderer.load());const n=this._addTileFeatureData(e);await this._featureRenderer.add(n,t)}async remove(e,t){const n=this._getFeatureSetFromTileId(e);n&&(this._featureRenderer&&this._featureRenderer.remove(n,t),this._removeTileFeatureData(e))}_getFeatureSetFromTileId(e){return this._tileFeatureData.get(e)}_addTileFeatureData(e){const t=e.descriptor.id,n=e.pages.reduce((i,{featureCount:a})=>i+a,0),s=new te(e,n);return this._tileFeatureData.set(t,s),s}_removeTileFeatureData(e){const t=this._tileFeatureData.get(e);t&&(t.dispose(),this._tileFeatureData.delete(e))}}let B=class extends K.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new Ye,this._tileManager=new b({addTile:(r,e)=>this._addTile(r,e),removeTiles:r=>this._removeTiles(r)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}async setup({viewSpatialReference:r,renderSpatialReference:e,viewingMode:t,baseQuery:n,url:s,objectIdField:i,capabilities:a,fieldsIndex:o,timeInfo:c}){this._renderCommandContext=new rt({viewingMode:t,dispatchRenderCommandsCallback:(d,h)=>this.remoteClient.invoke("dispatchRenderCommands",d,{transferList:h})});const u=J.fromJSON(r),l=J.fromJSON(e);return this._fetcher=new Ke(u,q.fromJSON(n),s,i,a),this._symbolizer=new mt({viewSpatialReference:u,renderSpatialReference:l,viewingMode:t}),this._queryEngine=new Pe({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:o,availableFields:[i],spatialReference:r,featureStore:this._featureStore,timeInfo:c}),this._defaultQueryJSON=new q({outSpatialReference:u}).toJSON(),this.addHandles(ke(()=>this.updating,async d=>{this.emit("notify-updating",{updating:d})}),Le),Z}async executeQuery(r,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(r),e)}}async executeQueryForIds(r,e){const t=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(r),e);return{result:Array.from(t)}}async executeQueryForCount(r,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(r),e)}}async executeQueryForExtent(r,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(r),e)}}async executeQueryForLatestObservations(r,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(r),e)}}async onTileTreeChange(r){return await this._tileManager.onTileTreeChange(r),Z}async _addTile(r,e){const t=await this._fetcher.fetch(r,e);M(e),this._featureStore.addTile(t);const n=this._renderCommandContext.createEncoder();return await this._symbolizer.add(t,n),await n.dispatch(),t}async _removeTiles(r){const e=this._renderCommandContext.createEncoder(),t=this._featureStore,n=this._symbolizer;for(const s of r)t.removeTile(s.tileId),await n.remove(s.tileId,e);await e.dispatch()}_ensureQuery(r){return r??this._defaultQueryJSON}};w([O()],B.prototype,"updating",null),B=w([N("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],B);const lr=B,Z={result:void 0};export{lr as default};

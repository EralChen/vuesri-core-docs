import{wU as H,aH as h,gO as T,h1 as $,h3 as M,wV as W,lu as _,gN as Y,gP as F,qZ as z,bH as Q,kX as J,hd as K,E as q,ad as ee,a6 as te,lE as re,gZ as v,gR as R,gS as S,gV as L,gW as P,h9 as U,h7 as ae,qX as oe,wW as ie,gY as ne,gU as se,g$ as I,h4 as me,gT as w}from"./chunk-CMhy9c9G.js";import{e as le,u as pe,V as ue,c as ce}from"./chunk-CZmFIMBn.js";import{V as de}from"./chunk-895G59h-.js";import{E as ye,u as fe}from"./chunk-CmFK1iGu.js";import{u as he}from"./chunk-Dc5RCiI0.js";import{R as we}from"./chunk-zKPkODU6.js";import{V as ge}from"./chunk-BcJWwafW.js";import{V as xe}from"./chunk-BY_FN4O4.js";import"./chunk-Dx0NO5tE.js";import"./chunk-hcQCkdqJ.js";import"./chunk-BCEYKtyI.js";import"./chunk-DfjCgXDb.js";import"./chunk-DIHKnm4l.js";import"./chunk-TufeK50d.js";import"./chunk-Dck1UqdK.js";import"./chunk-B4Rwpdzs.js";import"./chunk-igt1gBeK.js";import"./chunk-Cj_Zd08g.js";import"./chunk-BG40D5IJ.js";import"./chunk-Dzc4VObD.js";import"./chunk-DjjaYBlz.js";import"./chunk-CM_lIypp.js";import"./chunk-CmV2Xkqf.js";import"./chunk-CbY12eax.js";import"./chunk-ClYvIdCO.js";import"./chunk-QvQIJROn.js";import"./chunk-CdctZqhD.js";import"./chunk-DaHzAMiu.js";import"./chunk-C1aYhagP.js";import"./chunk-BU_CQVD8.js";import"./chunk-D_aEPSIR.js";import"./chunk-CAaD5fpi.js";import"./chunk-C0Px4IH5.js";import"./chunk-gN39URxt.js";import"./chunk-HNqUD5wH.js";import"./chunk-3xYMskso.js";import"./chunk-etnkt-xL.js";import"./chunk-oE2be0WM.js";import"./chunk-BnPJJ4xW.js";import"./chunk-DdA8NjGq.js";import"./chunk-scr1RBcv.js";import"./chunk-BVa6-kjc.js";import"./chunk-CIKSIPV2.js";import{V as Re,s as Se}from"./chunk-UsAGatjR.js";import"./chunk-C5o2Zojc.js";import"./chunk-ByM7454y.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-35-ZZMVr.js";import"./chunk-DHvBO4SR.js";import"./chunk-DAZPr-5t.js";import"./chunk-Ch0SDxT-.js";import"./chunk-B-RuJrXv.js";import"./chunk-CNtoRp8i.js";import"./chunk-CUOUzi7D.js";import"./chunk-_StMwdLk.js";import"./chunk-BShrVtfh.js";import"./chunk-AgXG-2tE.js";import"./chunk-DobUN8tB.js";/* empty css              */import"./chunk-CLFhYyJ8.js";import"./chunk-CLwfGE1I.js";import"./chunk--OMOLJvv.js";import"./chunk-BqmX71u_.js";import"./chunk-2F9zfzHu.js";import"./chunk-PTUe1aNG.js";/* empty css              */import"./chunk-DZzPOt9C.js";/* empty css              *//* empty css              */import"./chunk-CNgyMX9t.js";import"./chunk-frOQcENt.js";import"./chunk-Ds9r7LkQ.js";import"./chunk-Dz7Zvk-S.js";import"./chunk-_SCJxduo.js";var Ve=0;function O(e){var r=++Ve;return H(e)+r}const be={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new h({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3},showGeoSlot:{type:Boolean,default:!1}},ke={...le,load:e=>e,request:e=>e};function G(e,r,a="id"){const p=[],o=r.reduce((m,l)=>{const s=l[a];return m.set(s,l),m},new Map),u=e.reduce((m,l)=>{const s=l[a];return o.has(s)?(p.push(l),o.delete(s)):m.set(s,l),m},new Map),c=[...o.values()],n=[...u.values()];return{addMap:o,deleteMap:u,updateRows:p,addRows:c,deleteRows:n}}const X=new we({baseURL:""}),Ee=async(e,r,a={},p={})=>X.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...p}).then(o=>(o.elements.forEach(u=>{u.id=r.LAYER+"_"+u.id}),o)),ve=async(e,r,a={},p={})=>X.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...p}),Le=T({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=pe(),p=u(),o=a.when.bind(a);a.when=(...n)=>p.then(()=>o(...n));function u(){return ve(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:c}).then(n=>{n.extent&&(n.extent=new h(n.extent)),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n,a.capabilitiesResponse=n})}function c(n){const m=n.headers;for(const l in r.headers)m.set(l,r.headers[l]);return n}return(n,m)=>$(n.$slots,"default")}}),Te=T({name:"VaMediaTileLayer",components:{VaMediaLayer:ue,Capabilities:Le,VaGraphicsLayer:ge},props:be,emits:ke,setup(e,{emit:r}){const a=he(),p=ce(r,["load"]),o=new de({elements:[]}),u=M(),c=W(),n=t=>{t.layer.when(()=>{u.value=t.layer}),t.layer.on("layerview-create",i=>{c.resolve(i.layerView)}),z(()=>{r("load",t)})},m=async t=>{const i=await c.promise;Q(()=>!i.updating).then(t)},l=new J,s=_({SERVICE:"ZZTS"}),y=()=>{s.LAYER=e.layerName,s.SCALE=a.scale;let t=a.extent;t&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=K(a.extent));const i=t;i&&(s.BBOX=new h({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}})),s.HEIGHT=a.height,s.WIDTH=a.width},f=a.watch("stationary",t=>{t&&N()});l.add(f),Y(()=>{l.removeAll()});const B=_({zoom:0});function C(t){t.length!==0&&m(()=>o.elements.addMany(t))}function N(){y(),Z()}F(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{N()},{immediate:!0,deep:!0});function j(t){if(t.type==="image"){const i=new ye({image:t.url,georeference:new fe({extent:{...t.extent,spatialReference:{wkid:4326}}})});return i.id=t.id,i}}function A(t){const i=t.headers;for(const d in e.headers)i.set(d,e.headers[d]);return t}const V=M([]),D=t=>{V.value=[];const i=[];t.forEach(d=>{i.push(new q({geometry:new h({...d.extent,spatialReference:{wkid:4326}}).center,attributes:{id:O()},symbol:new ee({text:d.id.split("_")[1],color:"red",font:{size:12,weight:"bold"}})})),i.push(new q({geometry:new h({...d.extent,spatialReference:{wkid:4326}}),attributes:{id:O()},symbol:new te({color:[255,0,0,0],outline:{color:[255,0,0,1],width:1}})}))}),V.value=i};function Z(){if(e.url)return Ee(e.url,s,e.customParameters,{queue:{id:e.layerName,mode:"wait"},setRequestInit:A}).then(async t=>{r("request",t);const i=o.elements.toArray();let d=!1,b=[];t.zoom!==B.zoom&&(d=!0,b=i),B.zoom=t.zoom;const k=[];if(t.elements){e.showGeoSlot&&D(t.elements);for(const E of t.elements){const g=j(E);g&&k.push(g)}if(d)C(k);else{const{addRows:E,deleteRows:g}=G(i,k,"id");C(E),b=g}return b}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:i}=G(o.elements.toArray(),t,"id");i.length!==0&&(c.value?.updating||m(()=>o.elements.removeMany(i)))},400)}).catch(t=>{console.error(t)})}return{layerLoad:n,source:o,layerEmits:p,geoslotSource:V}}});function Be(e,r,a,p,o,u){const c=v("Capabilities"),n=v("VaGraphicsLayer"),m=v("VaMediaLayer");return R(),S(m,ae({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},oe(e.layerEmits)),{default:L(()=>[P(c,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),$(e.$slots,"default"),e.showGeoSlot?(R(),S(n,{key:0,graphics:e.geoslotSource},null,8,["graphics"])):U("",!0)]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const x=re(Te,[["render",Be]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const Ce="http://t1.zjsophon.com:10000/zz/zz-mapServer/proxy/mapServer/layer/media",Tr=T({__name:"basic",setup(e){const r=ie(z),p={center:new h({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=ne({url:Ce,layerName:"SSTD:D20240822-000259-P0",token:"ce6373e184cf2df93f486e03a8189cb7"}),u=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],c=async s=>{const y=s.view;await s.layer.when();const f=s.layer.capabilities.extent;console.log(f),await y.when(),f&&y.goTo(f)},n=se(0),m=s=>{n.value=s.zoom},l=s=>{console.log(s.result?.element.get("id"))};return(s,y)=>(R(),S(w(xe),{"default-options":p},{before:L(()=>[I("p",null,[I("span",null,"当前缩放级别: "+me(n.value),1)]),P(w(Re),{"label-width":100,"form-items":u,data:o,onSetData:y[0]||(y[0]=f=>w(Se)(o,f))},null,8,["data"])]),default:L(()=>[w(r)?U("",!0):(R(),S(w(x),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},"show-geo-slot":!0,onLoad:c,onClick:l,onRequest:m},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Tr as default};

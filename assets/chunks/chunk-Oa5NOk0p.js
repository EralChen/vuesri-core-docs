import{V as O}from"./chunk-kd0F-y8E.js";import{V as $}from"./chunk-O3wZbxMk.js";import{V as P}from"./chunk-ADbKWz_2.js";import{p as j,a as z,b as B,d as C,e as G,f as I}from"./chunk-pxSSoWZz.js";import{gY as M,gT as g,ly as F,lD as R,hb as k,tf as A,tg as H,a0 as D,a2 as W,h6 as q,hd as L,g$ as N,h0 as U,h3 as v,h1 as f,h5 as m,he as Y,h9 as Z}from"./chunk-fyrbxnSH.js";import{u as J}from"./chunk-_N6gej9z.js";import{V as K,s as Q}from"./chunk-dbjzebwm.js";import"./chunk-qn7jb9-b.js";import{V as X}from"./chunk-lBa4w8aQ.js";import{V as ee}from"./chunk-41oGK5L-.js";import"./chunk-B3AFDltd.js";import"./chunk-lD6t8LMi.js";import"./chunk-DnUVT2kT.js";import"./chunk-Cq8UfG38.js";import"./chunk-J56G0tfX.js";import"./chunk-gQEVD-8d.js";import"./chunk-vMx9XH42.js";import"./chunk-AQtzEpXZ.js";import"./chunk-T36RDINh.js";import"./chunk-P9tUIRkp.js";import"./chunk-MTRZ_l68.js";import"./chunk-Mx5yI2Yn.js";import"./chunk-f83L__eB.js";import"./chunk-I0yzb-TT.js";import"./chunk-FEI8nmeL.js";import"./chunk-bWLF_K-H.js";import"./chunk-qi3bAG5m.js";import"./chunk-19dCrj45.js";import"./chunk-0F1EjARU.js";const te={...j,defaultOptions:{type:Object,default:()=>({})},source:{type:Array,default:()=>[]},renderer:{type:Object,default:void 0}},re={load:r=>r},ae=M({name:"VaLocalElevationLayer",props:te,emits:re,setup(r,{emit:t}){const a=J(),e=new h({...r.defaultOptions});return g(()=>{e.source=r.source}),g(()=>{r.renderer&&(e.renderer=r.renderer)}),z(a.map.ground.layers,e,r),B(e,r),C(a,r,s=>{e.visible=s}),F("vaLayer",e),t("load",{view:a,layer:e}),{}}});function se(r,t,a,e,s,i){return k(r.$slots,"default")}const y=R(ae,[["render",se]]);var oe=Object.defineProperty,ne=Object.getOwnPropertyDescriptor,w=(r,t,a,e)=>{for(var s=e>1?void 0:e?ne(t,a):t,i=r.length-1,n;i>=0;i--)(n=r[i])&&(s=(e?n(t,a,s):n(s))||s);return e&&s&&oe(t,a,s),s};let h=class extends A{constructor(r){super(r),this.source=[],this.renderer=new V({}),this.elevationMap=new Map,this.reshow=H(this._reshow,400),r.source&&(this.source=r.source),r.renderer&&(this.renderer=r.renderer);const t=this.watch("source",e=>{e?.length&&(this.fullExtent=G(e),this.refresh())}),a=this.watch("renderer",e=>{this.renderer=e,this.refresh()});this.addHandles(t),this.addHandles(a)}initElevationMap(){if(this.elevationMap.clear(),this.renderer.type==="local-elevation-unique-value"){const r=this.renderer;this.source.forEach(t=>{const a=t.attributes[r.field];if(a==null){this.elevationMap.set(t,this.renderer.defaultElevation);return}r.uniqueValueInfos.some(e=>e.value===a?(this.elevationMap.set(t,e.elevation),!0):!1)})}if(this.renderer.type==="local-elevation-geometry"){const r=this.renderer;this.source.forEach(t=>{this.elevationMap.set(t,r.expression(t))})}}async load(r){return await super.load(r)}_reshow(){this.visible=!1,Promise.resolve().then(()=>{this.visible=!0})}refresh(){this.initElevationMap(),this.reshow()}async fetchTile(r,t,a,e){if(!this.source?.length)return null;const[s,i]=this.getTileBounds(r,t,a),n=256,o=n+1,c={values:new Float32Array(o*o).fill(0),width:o,height:o,maxZError:-1e3,noDataValue:e?.noDataValue},d=this.tileInfo?.lods[r].resolution;if(!d)return null;for(let l=0;l<o;l++)for(let p=0;p<o;p++){let E=!1,_=null;this.source.some(b=>{const x=b.geometry;if(x.type!=="polygon")return!1;if(x.rings.some(T=>this.rayCasting([s+p*d,i+l*d],T)))return E=!0,_=b,!0}),c.values[(n-l)*o+p]=E?this.elevationMap.get(_)??this.renderer.defaultElevation:void 0}return c}rayCasting(r,t){const a=r[0],e=r[1];let s=!1;for(let i=0,n=t.length,o=n-1;i<n;o=i,i++){const u=t[i][0],c=t[i][1],d=t[o][0],l=t[o][1];if(u===a&&c===e||d===a&&l===e)return!0;if(c<e&&l>=e||c>=e&&l<e){const p=u+(e-c)*(d-u)/(l-c);if(p===a)return!0;p>a&&(s=!s)}}return s}};w([D()],h.prototype,"source",2);w([D()],h.prototype,"renderer",2);h=w([W("vuesri.core.LocalElevationLayer")],h);class S{constructor(t){this.defaultElevation=-100,t.defaultElevation!==void 0&&(this.defaultElevation=t.defaultElevation)}}class V extends S{constructor(t){super(t),this.type="local-elevation-geometry",this.expression=a=>{const e=a.geometry;return e.type!=="polygon"?this.defaultElevation:this.getPolygonMinz(e)},t.expression&&(this.expression=t.expression)}getPolygonMinz(t){const e=I(t).flat();return Math.min(...e.map(s=>s.z).filter(s=>typeof s=="number"))}}y.install=r=>{r.component(y.name||"VaLocalElevationLayer",y)};const Ge=M({__name:"basic",setup(r){const t=q({type:"default",elevation:0}),a=[{templateType:"VkfRadio",prop:"type",label:"Type",options:[{label:"default",value:"default"},{label:"geometry",value:"geometry"}]},{templateType:"VkfSlider",prop:"elevation",label:"Elevation",min:-1e3,max:1e3,templateIf:n=>n?.type==="default"}],e=L([]),s=L(new V({}));g(()=>{t.type==="geometry"?s.value=new V({}):s.value=new S({defaultElevation:t.elevation})});const i=async({view:n,layer:o})=>{await n.when(),await o.when(),n.goTo(o.fullExtent,{animate:!1})};return(n,o)=>(N(),U(f(O),{"default-options":{zoom:2}},{before:v(()=>[m(f(K),{"form-items":a,data:t,onSetData:o[0]||(o[0]=u=>f(Q)(t,u))},null,8,["data"])]),after:v(()=>[Z("pre",null,Y(e.value),1)]),default:v(()=>[m(f($),{type:"vec_w",anno:!1,"spatial-reference":{wkid:3857}}),m(f(P),{url:"https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"}),m(f(y),{source:e.value,renderer:s.value,onLoad:i},null,8,["source","renderer"]),m(f(ee),null,{default:v(()=>[m(f(X),{modelValue:e.value,"onUpdate:modelValue":o[1]||(o[1]=u=>e.value=u),"available-creature-tools":["polygon"],"default-options":{visibleElements:{selectionTools:{"lasso-selection":!1,"rectangle-selection":!1}}}},null,8,["modelValue"])]),_:1})]),_:1}))}});export{Ge as default};

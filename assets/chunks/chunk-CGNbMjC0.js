import{qq as k,qr as w,qp as z,fE as N,c0 as V,aR as A,qD as U,rE as F,rF as G,rG as W,rH as Z,rI as j,rJ as K,rK as Y,m1 as D,qu as p,nn as J,m2 as S,b3 as x,s as Q,rL as X,rM as ee,b$ as te,am as ie,au as se,qA as E,eG as le,cm as re,ag as H,a1 as u,a2 as m,a4 as ae,bZ as ne}from"./chunk-CGsGeN7j.js";import{n as oe,e as he,l as ce,h as de,t as ue}from"./chunk-ChYaVpT0.js";import{p as me}from"./chunk-DgcQgLzk.js";import{n as pe}from"./chunk-DRtAJHF_.js";import{c as ge}from"./chunk-B0t6_TBH.js";import"./chunk-ByM7454y.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-C6qG8a15.js";import"./chunk-D5zmR9t2.js";import"./chunk-CQnMSTh-.js";class ye{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,r=0;const l=this._shift+this.getLevelShift(e[0]);if(l){const i=(1<<l)-1,a=t/(this._scale*(1<<l-1));s=(e[2]&i)*a,r=(e[1]&i)*a}return[s,r]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}function fe(n){const e=[],t=new oe(4096,e,()=>{const r=new z;return r.show=!1,r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r}),s=new he(e,t,(r,l,i)=>new ce(r,l,i,n.styleRepository,n.key.level,0),(r,l)=>{k(r,l,!1)},()=>0,r=>{const l=n.styleRepository.getStyleLayerByUID(r).getLayoutProperty("visibility");return!l||l.getValue()!==w.NONE});e.push(n),t.add(n),s.setScreenSize(512,512),s.continue(1/0)}class P extends de{constructor(e,t,s,r){super(e,t,s,e.tileInfo.lods.length-1),this._memCache=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new ue(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,s,r){const l=new N(e,t,s,0);let i=this._memCache.get(l.id);if(i!=null)return i.retain(),i;const a=await this._getVectorTileData(l);if(V(r),!this._layer)return null;if(i=this._memCache.get(l.id),i!=null)return i.retain(),i;const o=this._layer.tileInfo.getTileBounds(A(),l),c=this._tileInfoView.getTileResolution(e);return i=new U(l,c,o[0],o[3],512,512,this._styleRepository,this._memCache),a?(i.setData(a),i.retain(),this._memCache.put(l.id,i,i.usedMemory,F)):i.setData(null),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=G(1/8,0,0,0,1/8,0,0,0,1),fe(i),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,r={signal:s.signal},l=this._getParsedVectorTileData(e,r).then(i=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),i)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,l),this._ongoingRequestToController.set(t,s),l}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}}const _e={vtlBackground:W,vtlFill:Z,vtlLine:j,vtlCircle:K,vtlSymbol:Y},_=1e-6;class q{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new me}dispose(){this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache=null),this._vtlMaterialManager=D(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){const r=s.layers;e.renderPass="translucent";for(let l=0;l<r.length;l++){const i=r[l];if(i.type!==p.SYMBOL)continue;const a=i.getLayoutProperty("visibility");if(a&&a.getValue()===w.NONE)continue;const o=e.displayLevel;i.minzoom!==void 0&&i.minzoom>o+_||i.maxzoom!==void 0&&i.maxzoom<=o-_||(e.styleLayerUID=i.uid,e.styleLayer=i,this._drawWithBrush(e,t,"vtlSymbol"))}}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;const{context:r,displayLevel:l,requiredLevel:i}=e;t.key.level=i,r.setBlendingEnabled(!0),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!1),e.renderPass="background",s.backgroundBucketIds.forEach(a=>{const o=s.getLayerById(a);if(o.type!==p.BACKGROUND)return;const c=o.getLayoutProperty("visibility");c&&c.getValue()===w.NONE||o.minzoom!==void 0&&o.minzoom>l+_||o.maxzoom!==void 0&&o.maxzoom<=l-_||(e.styleLayerUID=o.uid,e.styleLayer=o,this._drawWithBrush(e,t,"vtlBackground"))})}drawTile(e,t,s,r){const{context:l}=e,i=s.layers;l.setBlendingEnabled(!1),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),l.setDepthFunction(J.LEQUAL),e.renderPass="opaque";for(let a=i.length-1;a>=0;a--){const o=i[a];r!=null&&r!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunctionSeparate(S.ONE,S.ONE_MINUS_SRC_ALPHA,S.ONE,S.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let a=0;a<i.length;a++){const o=i[a];r!=null&&r!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthTestEnabled(!1),l.bindVAO()}_renderStyleLayer(e,t,s,r){if(!(r||e&&s.layerData.has(e.uid)))return;const l=e.getLayoutProperty("visibility");if(l&&l.getValue()===w.NONE)return;const{renderPass:i}=t;let a;switch(e.type){case p.BACKGROUND:if(i!=="background")return;a="vtlBackground";break;case p.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;a="vtlFill";break;case p.LINE:if(i!=="translucent")return;a="vtlLine";break;case p.CIRCLE:if(i!=="translucent")return;a="vtlCircle";break;case p.SYMBOL:if(i!=="translucent")return;a="vtlSymbol"}const o=t.displayLevel;if(e.minzoom!==void 0&&e.minzoom>o+_||e.maxzoom!==void 0&&e.maxzoom<=o-_)return;const{context:c}=t;c.setStencilTestEnabled(!1),c.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,s,a)}_drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const r=_e[s];this._brushCache.set(s,new r)}this._brushCache.get(s).drawMany(e,[t])}}let h=class extends ge(pe(ne)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=x("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new Q("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:n,spatialReference:e,state:t,viewingMode:s}=this.view,r=s==="local"&&!X(e)||ee.force512VTL,l=this.layer.tileInfo.spatialReference.isGeographic,i=r?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,l?1:2),a=this._getTileInfoSupportError(i,this.layer.fullExtent);if(a!=null)return this.addResolvingPromise(Promise.reject(a));const o=te(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const d=n.tilingScheme,g=d.pixelSize,b=g===256?1:2,y=n.spatialReference?.isGeographic&&g===256?1:0,v=n.spatialReference?.isGeographic||g!==256?0:1;let f;if(this.schemaHelper=new ye(b,y,this.levelShift+v),g===256){const L=this.layer.tileInfo.spatialReference.isGeographic;f=this.layer.tileInfo.getOrCreateCompatible(256,L?1:2)}else f=this.view.spatialReference?.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const C=this._getTileInfoCompatibilityError(f,d);if(C)throw C;this.tileInfo=f});this._tileHandlerController=new AbortController;const c=this.view.resourceController;this._memCache=c.memoryController.newCache(`vtl-${this.layer.uid}`,d=>{d.release()}),this.addHandles(ie(()=>this.view.qualitySettings.memoryLimit,d=>this._memCache.maxSize=Math.ceil(d/10*1048576),se));const O=new E(this.layer.currentStyleInfo.style);this._tileHandler=new P(this.layer,O,t.contentPixelRatio,this._memCache);const R=this._tileHandlerController.signal,T=ve(c),I=this._tileHandler.start({signal:R,schedule:T}),M=this._tileHandler.spriteMosaic;M.then(d=>{!le(R)&&this._tileHandler&&(this.painter=new q(d,this._tileHandler.glyphMosaic))}),I.then(()=>this._tileHandlerController=null),this._updatingHandles.add(()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio}),({style:d,pixelRatio:g})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const b=new E(d),y=new P(this.layer,b,g,this._memCache),v=y.start({signal:this._tileHandlerController.signal,schedule:T}),f=y.spriteMosaic;v.then(()=>this._tileHandlerController=null),this._updatingHandles.addPromise(Promise.all([v,f]).then(([,C])=>{const L=this._tileHandler,$=this.painter;this.painter=new q(C,y.glyphMosaic),this._tileHandler=y,this.emit("data-changed"),L.destroy(),$&&$.dispose()}))});const B=Promise.all([o,I,M]);this.addResolvingPromise(B)}destroy(){this.painter=D(this.painter),this._tileHandlerController=re(this._tileHandlerController),this._tileHandler=H(this._tileHandler),this._memCache=H(this._memCache)}get contentZoom(){return x("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const n=this.tileInfo.lods,e=this.layer.minScale||n[0].scale,t=this.layer.maxScale||n[n.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const n=this.tileInfo.lods;return{minScale:n[0].scale,maxScale:n[n.length-1].scale}}get dataLevelRange(){const{minScale:n,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(n,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(n,e,t,s){return this._tileHandler.getVectorTile(n,e,t,s)}};u([m()],h.prototype,"layer",void 0),u([m()],h.prototype,"levelShift",void 0),u([m()],h.prototype,"contentZoom",null),u([m()],h.prototype,"displayLevelRange",null),u([m()],h.prototype,"tileInfo",void 0),u([m()],h.prototype,"dataScaleRange",null),u([m()],h.prototype,"dataLevelRange",null),u([m()],h.prototype,"updatingProgressValue",void 0),h=u([ae("esri.views.3d.layers.VectorTileLayerView3D")],h);const nt=h;function ve(n){return e=>n.immediate.schedule(e)}export{nt as default};

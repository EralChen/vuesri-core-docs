import{br as R,gZ as v,hc as q,he as _,lt as M,oC as D,gX as z,g_ as G,oG as P,dg as H,mI as Q,hn as W,lD as Y,h8 as O,h0 as b,h1 as S,h4 as B,h6 as L,lF as J,oE as K,tV as ee,h7 as te,h3 as ae,hf as re,ha as I,h2 as y,hj as ne}from"./chunk-PoaGf_98.js";import{e as oe,u as se,V as ie,c as me}from"./chunk-7lfnsrDw.js";import{V as le,b as ue,u as ce}from"./chunk-TndIPZDn.js";import{u as pe}from"./chunk-fdkMBDAT.js";import{R as de}from"./chunk-FEI8nmeL.js";import{V as fe}from"./chunk-VqDFnfwU.js";import"./chunk-KCuVYITE.js";import"./chunk-f8_x--yi.js";import"./chunk-t4G58iwi.js";import"./chunk-JJP0gO-D.js";import"./chunk-TtcwWQmg.js";import"./chunk-uUWYMKgw.js";import"./chunk-cwvyK10d.js";import{V as ye}from"./chunk-lGUkydyE.js";import"./chunk-Vc6XN2jq.js";import"./chunk-aHtA88ju.js";import"./chunk-DurUjVE2.js";import"./chunk-pYh8tnaQ.js";import"./chunk-RQoiRbqi.js";import"./chunk-QtPtpRa6.js";import"./chunk-K9LCOMF1.js";import"./chunk-ozbbkjUR.js";import"./chunk-C0Nayd1J.js";import"./chunk-qVqXPIrD.js";import"./chunk-b-DHhRTS.js";import"./chunk-zDKwM8s5.js";import"./chunk-3T7hKDca.js";import"./chunk-PLw0LGaa.js";import"./chunk-d5_ASDUn.js";import"./chunk-wT_rblN7.js";import"./chunk-ynUw59LF.js";import"./chunk-BxtH-GMI.js";import"./chunk-cPnqn7e0.js";import"./chunk-ui0i4iCm.js";import"./chunk-5pNT1GAd.js";import"./chunk-k9blvpoN.js";import"./chunk-XeI_S9zT.js";import"./chunk-gbmgz5fP.js";import"./chunk-pXxG0kL6.js";import"./chunk-d531ILRa.js";import"./chunk-l_kukfZW.js";import"./chunk-GVO47k7B.js";import{V as he,s as we}from"./chunk-VMrusuQ2.js";import"./chunk-Aw0WzKZ1.js";import"./chunk-k1Ha8fb3.js";import"./chunk-nRJGOpte.js";import"./chunk-B3AFDltd.js";import"./chunk-Os1UDk4a.js";import"./chunk-2vvX2e9D.js";import"./chunk-zVyniJax.js";import"./chunk-lroiD94h.js";import"./chunk-W1nA9CEe.js";import"./chunk-8jofAKRA.js";import"./chunk-S6QMefOS.js";import"./chunk-UTY-68XW.js";import"./chunk-awLhy6Ja.js";import"./chunk-hOphCBAO.js";import"./chunk--zoE-7FC.js";import"./chunk--5nHSvsg.js";import"./chunk-1Nhghl0W.js";import"./chunk-LLtDs3-D.js";import"./chunk-i1j5_Frc.js";import"./chunk-4z1AJ3R_.js";import"./chunk-AryjHcnu.js";import"./chunk-sfKxDDmP.js";import"./chunk-DVm6v2yh.js";import"./chunk-I0yzb-TT.js";const xe={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},Re={...oe,load:t=>t,request:t=>t};function N(t,r,a="id"){const u=[],o=r.reduce((c,l)=>{const s=l[a];return c.set(s,l),c},new Map),m=t.reduce((c,l)=>{const s=l[a];return o.has(s)?(u.push(l),o.delete(s)):c.set(s,l),c},new Map),d=[...o.values()],n=[...m.values()];return{addMap:o,deleteMap:m,updateRows:u,addRows:d,deleteRows:n}}const A=new de({baseURL:""}),Ee=async(t,r,a={},u={})=>A.request({baseURL:t,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...u}).then(o=>(o.elements.forEach(m=>{m.id=r.LAYER+"_"+m.id}),o)),Ve=async(t,r,a={},u={})=>A.request({baseURL:t,method:"GET",url:"",params:{...r,...a},...u}),ge=v({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(t){const r=t,a=se(),u=m(),o=a.when.bind(a);a.when=(...n)=>u.then(()=>o(...n));function m(){return Ve(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent&&(n.extent=new R(n.extent)),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const c=n.headers;for(const l in r.headers)c.set(l,r.headers[l]);return n}return(n,c)=>q(n.$slots,"default")}}),ke=v({name:"VaMediaTileLayer",components:{VaMediaLayer:ie,Capabilities:ge},props:xe,emits:Re,setup(t,{emit:r}){const a=pe(),u=Math.random().toString(36).substring(2,9),o=me(r,["load"]),m=new le({elements:[]}),d=_(),n=_(),c=e=>{e.layer.when(()=>{d.value=e.layer}),e.layer.on("layerview-create",i=>{n.value=i.layerView}),P(()=>{r("load",e)})},l=e=>{n.value&&H(()=>!n.value?.updating).then(e)},s=new Q,p=M({SERVICE:"ZZTS"}),f=()=>{p.LAYER=t.layerName,p.SCALE=a.scale;let e=a.extent;e&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(e=W(a.extent));const i=e;i&&(p.BBOX=new R({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}})),p.HEIGHT=a.height,p.WIDTH=a.width},$=a.watch("stationary",e=>{e&&E()});s.add($);const X=D(E,800),Z=a.on("drag",()=>{X()});s.add(Z),z(()=>{s.removeAll()});const C=M({zoom:0});function T(e){e.length!==0&&l(()=>m.elements.addMany(e))}function E(){a.when(()=>{f(),F()})}function F(){if(t.url)return Ee(t.url,p,t.customParameters,{queue:{id:u,mode:"abort"},setRequestInit:j}).then(async e=>{r("request",e);const i=m.elements.toArray();let h=!1,V=[];e.zoom!==C.zoom&&(h=!0,V=i),C.zoom=e.zoom;const g=[];if(e.elements){for(const k of e.elements){const w=U(k);w&&g.push(w)}if(h)T(g);else{const{addRows:k,deleteRows:w}=N(i,g,"id");T(k),V=w}return V}}).then(e=>{setTimeout(()=>{if(!e)return;const{updateRows:i}=N(m.elements.toArray(),e,"id");i.length!==0&&(n.value?.updating||l(()=>m.elements.removeMany(i)))},400)}).catch(e=>{e.name!=="AbortError"&&console.error(e)})}G(()=>[t.url,t.layerName,t.customParameters,t.headers],()=>{E()},{immediate:!0,deep:!0});function U(e){if(e.type==="image"){const i=new ue({image:e.url,georeference:new ce({extent:{...e.extent,spatialReference:{wkid:4326}}})});return i.id=e.id,i}}function j(e){const i=e.headers;for(const h in t.headers)i.set(h,t.headers[h]);return e}return{layerLoad:c,source:m,layerEmits:o}}});function be(t,r,a,u,o,m){const d=O("Capabilities"),n=O("VaMediaLayer");return b(),S(n,J({source:t.source,onLoad:t.layerLoad},K(t.layerEmits)),{default:B(()=>[L(d,{url:t.url,"layer-name":t.layerName,headers:t.headers,"custom-parameters":t.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),q(t.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Y(ke,[["render",be]]);x.install=t=>{t.component(x.name||"VaMediaTileLayer",x)};const Se="/test-api/layer/media",$t=v({__name:"basic",setup(t){const r=ee(P),u={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=te({url:Se,layerName:"SSTD:D20240606-000001-P0",token:"866E0318465B47C5B252F6F306EFA00EZ8ZX8VPJQIPF9POV"}),m=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async s=>{const p=s.view;await s.layer.when();const f=s.layer.capabilities.extent;console.log(f),await p.when(),f&&p.goTo(f)},n=ae(0),c=s=>{n.value=s.zoom},l=s=>{console.log(s.result?.element.get("id"))};return(s,p)=>(b(),S(y(fe),{"default-options":u},{before:B(()=>[I("p",null,[I("span",null,"当前缩放级别: "+re(n.value),1)]),L(y(he),{"label-width":100,"form-items":m,data:o,onSetData:p[0]||(p[0]=f=>y(we)(o,f))},null,8,["data"])]),default:B(()=>[L(y(ye),{type:"vec_c","spatial-reference":{wkid:4490}}),y(r)?ne("",!0):(b(),S(y(x),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},onLoad:d,onClick:l,onRequest:c},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{$t as default};

import{cJ as R,gZ as L,hc as q,he as M,lu as _,gX as X,g_ as Z,oH as A,bL as j,lQ as z,ho as H,lF as G,h8 as N,h0 as V,h1 as g,h4 as S,h6 as v,hi as W,oF as Q,t_ as Y,h7 as J,h3 as K,hf as ee,ha as I,h2 as y,hk as te}from"./chunk-xMPjLCrx.js";import{e as re,u as ae,V as ne,c as oe}from"./chunk-SZWX9kAq.js";import{V as se,b as ie,u as me}from"./chunk-2HCXqDJy.js";import{u as le}from"./chunk-J9RASU-T.js";import{R as ue}from"./chunk-YAzdkTjJ.js";import{V as pe}from"./chunk-5tsSCYgh.js";import"./chunk-i_6XDy5U.js";import"./chunk-0_GtP_p4.js";import"./chunk-2fXqQPVR.js";import"./chunk-9KZWtd42.js";import"./chunk-JLhCycX3.js";import"./chunk-NfHojIUH.js";import"./chunk-V11zOVoy.js";import{V as ce}from"./chunk-solU3qLG.js";import"./chunk-aWq6ArXi.js";import"./chunk-zMsd7moL.js";import"./chunk-QGZQfL-6.js";import"./chunk-bVSt-vq9.js";import"./chunk-w3qa_8IS.js";import"./chunk-KVNnRaiv.js";import"./chunk-HOjhYsx3.js";import"./chunk-Kk-FsYOI.js";import"./chunk-mQiHYxNr.js";import"./chunk-Vp0MFqt1.js";import"./chunk-xRfHx62q.js";import"./chunk-XFUWsSlJ.js";import"./chunk-3YEdJcEN.js";import"./chunk-1SEN342O.js";import"./chunk-FaStYSus.js";import"./chunk-ZZVIt58t.js";import"./chunk-E-RLbiwB.js";import"./chunk-raaMsR-G.js";import"./chunk-qxoGV1yl.js";import"./chunk-Bd5xscMd.js";import"./chunk-rerlXJLz.js";import"./chunk-LE__wJ9I.js";import"./chunk-g6Mu5kDo.js";import"./chunk-um3EVGjc.js";import"./chunk-bavg-2oE.js";import"./chunk-HLnvRq1G.js";import"./chunk-soETSAjW.js";import"./chunk-dR-Xmx-w.js";import{V as de,s as fe}from"./chunk-y6ytdDAi.js";import"./chunk-WHST2ZjR.js";import"./chunk-Qgrzwe6s.js";import"./chunk-rQi2mmfE.js";import"./chunk-B3AFDltd.js";import"./chunk-tmZ5iYy4.js";import"./chunk-gzqjvZQi.js";import"./chunk-X6bIPsmo.js";import"./chunk-4VDKJZsa.js";import"./chunk-PDwm1OQE.js";import"./chunk-Yt4e-NAn.js";import"./chunk-NM7_KTd2.js";import"./chunk-xWC1_lmp.js";import"./chunk-cBu6LOLZ.js";import"./chunk-esItw7VO.js";import"./chunk-0qOLKVtw.js";import"./chunk-tAXmGf4E.js";import"./chunk-wDLU_hcC.js";import"./chunk-1QMMptYd.js";import"./chunk-9vCejg7V.js";import"./chunk-FqhRJRvF.js";import"./chunk-QAEz0L2u.js";import"./chunk-QHcv4ANa.js";import"./chunk-LvfigmnP.js";const ye={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3}},he={...re,load:e=>e,request:e=>e};function O(e,r,a="id"){const u=[],o=r.reduce((p,l)=>{const i=l[a];return p.set(i,l),p},new Map),m=e.reduce((p,l)=>{const i=l[a];return o.has(i)?(u.push(l),o.delete(i)):p.set(i,l),p},new Map),d=[...o.values()],n=[...m.values()];return{addMap:o,deleteMap:m,updateRows:u,addRows:d,deleteRows:n}}const F=new ue({baseURL:""}),we=async(e,r,a={},u={})=>F.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...u}).then(o=>(o.elements.forEach(m=>{m.id=r.LAYER+"_"+m.id}),o)),xe=async(e,r,a={},u={})=>F.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...u}),Re=L({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=ae(),u=m(),o=a.when.bind(a);a.when=(...n)=>u.then(()=>o(...n));function m(){return xe(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent&&(n.extent=new R(n.extent)),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const p=n.headers;for(const l in r.headers)p.set(l,r.headers[l]);return n}return(n,p)=>q(n.$slots,"default")}}),Ee=L({name:"VaMediaTileLayer",components:{VaMediaLayer:ne,Capabilities:Re},props:ye,emits:he,setup(e,{emit:r}){const a=le(),u=Math.random().toString(36).substring(2,9),o=oe(r,["load"]),m=new se({elements:[]}),d=M(),n=M(),p=t=>{t.layer.when(()=>{d.value=t.layer}),t.layer.on("layerview-create",s=>{n.value=s.layerView}),A(()=>{r("load",t)})},l=t=>{n.value&&j(()=>!n.value?.updating).then(t)},i=new z,c=_({SERVICE:"ZZTS"}),f=()=>{c.LAYER=e.layerName,c.SCALE=a.scale;let t=a.extent;t&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=H(a.extent));const s=t;s&&(c.BBOX=new R({xmin:s.xmin,ymin:s.ymin,xmax:s.xmax,ymax:s.ymax,spatialReference:{wkid:4326}})),c.HEIGHT=a.height,c.WIDTH=a.width},P=a.watch("stationary",t=>{t&&C()});i.add(P),X(()=>{i.removeAll()});const B=_({zoom:0});function T(t){t.length!==0&&l(()=>m.elements.addMany(t))}function C(){a.when(()=>{f(),$()})}function $(){if(e.url)return we(e.url,c,e.customParameters,{queue:{id:u,mode:"abort"},setRequestInit:U}).then(async t=>{r("request",t);const s=m.elements.toArray();let h=!1,E=[];t.zoom!==B.zoom&&(h=!0,E=s),B.zoom=t.zoom;const k=[];if(t.elements){for(const b of t.elements){const w=D(b);w&&k.push(w)}if(h)T(k);else{const{addRows:b,deleteRows:w}=O(s,k,"id");T(b),E=w}return E}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:s}=O(m.elements.toArray(),t,"id");s.length!==0&&(n.value?.updating||l(()=>m.elements.removeMany(s)))},400)}).catch(t=>{t.name!=="AbortError"&&console.error(t)})}Z(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{C()},{immediate:!0,deep:!0});function D(t){if(t.type==="image"){const s=new ie({image:t.url,georeference:new me({extent:{...t.extent,spatialReference:{wkid:4326}}})});return s.id=t.id,s}}function U(t){const s=t.headers;for(const h in e.headers)s.set(h,e.headers[h]);return t}return{layerLoad:p,source:m,layerEmits:o}}});function ke(e,r,a,u,o,m){const d=N("Capabilities"),n=N("VaMediaLayer");return V(),g(n,W({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},Q(e.layerEmits)),{default:S(()=>[v(d,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),q(e.$slots,"default")]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const x=G(Ee,[["render",ke]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const be="/test-api/layer/media",Ot=L({__name:"basic",setup(e){const r=Y(A),u={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=J({url:be,layerName:"SSTD:D20240723-000052-P0",token:"8D626FD08BE249ADACEEF8990C8195F5EL47FBSWL3FAH11I"}),m=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async i=>{const c=i.view;await i.layer.when();const f=i.layer.capabilities.extent;console.log(f),await c.when(),f&&c.goTo(f)},n=K(0),p=i=>{n.value=i.zoom},l=i=>{console.log(i.result?.element.get("id"))};return(i,c)=>(V(),g(y(pe),{"default-options":u},{before:S(()=>[I("p",null,[I("span",null,"当前缩放级别: "+ee(n.value),1)]),v(y(de),{"label-width":100,"form-items":m,data:o,onSetData:c[0]||(c[0]=f=>y(fe)(o,f))},null,8,["data"])]),default:S(()=>[v(y(ce),{type:"vec_c","spatial-reference":{wkid:4490}}),y(r)?te("",!0):(V(),g(y(x),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},onLoad:d,onClick:l,onRequest:p},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Ot as default};

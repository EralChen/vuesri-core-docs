import{br as R,gY as v,hb as N,hd as M,lt as _,oB as j,gW as z,oG as P,dg as G,mI as W,hm as H,lD as Q,h7 as O,g$ as b,h0 as E,h3 as S,h5 as B,lF as Y,oD as J,tU as K,h6 as ee,h2 as te,he as ae,h9 as I,h1 as f,hi as re}from"./chunk-VRza80L0.js";import{e as ne,u as oe,V as se,c as ie}from"./chunk-35Q3Zvpu.js";import{V as me,b as le,u as pe}from"./chunk-1vnZQlal.js";import{u as ue}from"./chunk-iptrbIQE.js";import{R as ce}from"./chunk-FEI8nmeL.js";import{V as de}from"./chunk-92_EPZ_9.js";import"./chunk-pXMPEDJQ.js";import"./chunk-TJxHKQaJ.js";import"./chunk-X4AMdtwY.js";import"./chunk-vcak-BNh.js";import"./chunk-1fk78kYS.js";import"./chunk-upWfcRjm.js";import"./chunk-3dwqCJ3N.js";import{V as fe}from"./chunk-8F4dk0-n.js";import"./chunk-YiBhCNSZ.js";import"./chunk-mFa6NMiX.js";import"./chunk-GJiyZlux.js";import"./chunk-1_dHra1d.js";import"./chunk-mw0PRWNE.js";import"./chunk-8j8dWpzP.js";import"./chunk-OiKODbwX.js";import"./chunk-v-cjFPtK.js";import"./chunk-OtIAMpFg.js";import"./chunk-sGaIlAC7.js";import"./chunk-acu7Imc1.js";import"./chunk-CMK9UrlK.js";import"./chunk-jWHc2-2i.js";import"./chunk-ZYM1eN_o.js";import"./chunk-IToFNndw.js";import"./chunk-DRXW32go.js";import"./chunk-zusElswd.js";import"./chunk-xjgA--kk.js";import"./chunk-6IZG8hpE.js";import"./chunk-UXGi2gdt.js";import"./chunk-Z3PvAlF-.js";import"./chunk-_KemnKH4.js";import"./chunk-87nbIRNF.js";import"./chunk-ZfVKA05G.js";import"./chunk-7csqa4sh.js";import"./chunk-UM89hvUg.js";import"./chunk--a03eD9v.js";import"./chunk-fYWOfU7h.js";import{V as ye,s as he}from"./chunk-kISRyxhH.js";import"./chunk-zmnuLpAA.js";import"./chunk-f83L__eB.js";import"./chunk-WgvbwtiK.js";import"./chunk-B3AFDltd.js";import"./chunk-K1iWAS5e.js";import"./chunk-EBSwZf5y.js";import"./chunk-kkmfP6Iz.js";import"./chunk-ZOJxVOyq.js";import"./chunk-o93gGJyO.js";import"./chunk-P2kUoOsB.js";import"./chunk-Cdtwk75O.js";import"./chunk-dDxkJaNB.js";import"./chunk-T2EvZJF9.js";import"./chunk-qjI7xFPl.js";import"./chunk--IH1hFHy.js";import"./chunk-V-ZUmSRJ.js";import"./chunk-N23wYtQv.js";import"./chunk-hj9a9y-4.js";import"./chunk-IUylLgYj.js";import"./chunk-4cwFPPXB.js";import"./chunk-jcj_FjNN.js";import"./chunk-IVpRGXWM.js";import"./chunk--7ddx-IS.js";import"./chunk-u8xdCC6Y.js";const we={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},xe={...ne,load:t=>t,request:t=>t};function q(t,r,a="id"){const l=[],s=r.reduce((u,m)=>{const o=m[a];return u.set(o,m),u},new Map),p=t.reduce((u,m)=>{const o=m[a];return s.has(o)?(l.push(m),s.delete(o)):u.set(o,m),u},new Map),d=[...s.values()],n=[...p.values()];return{addMap:s,deleteMap:p,updateRows:l,addRows:d,deleteRows:n}}const $=new ce({baseURL:""}),Re=async(t,r,a={},l={})=>$.request({baseURL:t,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...l}),Ve=async(t,r,a={},l={})=>$.request({baseURL:t,method:"GET",url:"",params:{...r,...a},...l}),ge=v({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(t){const r=t,a=oe(),l=p(),s=a.when.bind(a);a.when=(...n)=>l.then(()=>s(...n));function p(){return Ve(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent=new R(n.extent),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const u=n.headers;for(const m in r.headers)u.set(m,r.headers[m]);return n}return(n,u)=>N(n.$slots,"default")}}),ke=v({name:"VaMediaTileLayer",components:{VaMediaLayer:se,Capabilities:ge},props:we,emits:xe,setup(t,{emit:r}){const a=ue(),l=Math.random().toString(36).substring(2,9),s=ie(r,["load"]),p=new me({elements:[]}),d=M(),n=M(),u=e=>{e.layer.when(()=>{d.value=e.layer}),e.layer.on("layerview-create",i=>{n.value=i.layerView}),P(()=>{r("load",e)})},m=e=>{n.value&&G(()=>!n.value?.updating).then(e)},o=new W,c=_({SERVICE:"ZZTS"}),y=()=>{c.LAYER=t.layerName,c.SCALE=a.scale;let e=a.extent;(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(e=H(a.extent));const i=e;c.BBOX=new R({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}}),c.HEIGHT=a.height,c.WIDTH=a.width},U=a.watch("stationary",e=>{e&&C()});o.add(U);const A=j(C,800),D=a.on("drag",()=>{A()});o.add(D),z(()=>{o.removeAll()});const L=_({zoom:0});function T(e){e.length!==0&&m(()=>p.elements.addMany(e))}function C(){y(),F()}function F(){if(t.url)return Re(t.url,c,t.customParameters,{queue:{id:l,mode:"abort"},setRequestInit:Z}).then(async e=>{r("request",e);const i=p.elements.toArray();let h=!1,V=[];e.zoom!==L.zoom&&(h=!0,V=i),L.zoom=e.zoom;const g=[];if(e.elements){for(const k of e.elements){const w=X(k);w&&g.push(w)}if(h)T(g);else{const{addRows:k,deleteRows:w}=q(i,g,"id");T(k),V=w}return V}}).then(e=>{setTimeout(()=>{if(!e)return;const{updateRows:i}=q(p.elements.toArray(),e,"id");i.length!==0&&(n.value?.updating||m(()=>p.elements.removeMany(i)))},400)})}function X(e){if(e.type==="image"){const i=new le({image:e.url,georeference:new pe({extent:{...e.extent,spatialReference:{wkid:4326}}})});return i.id=e.id,i}}function Z(e){const i=e.headers;for(const h in t.headers)i.set(h,t.headers[h]);return e}return{layerLoad:u,source:p,layerEmits:s}}});function be(t,r,a,l,s,p){const d=O("Capabilities"),n=O("VaMediaLayer");return b(),E(n,Y({source:t.source,onLoad:t.layerLoad},J(t.layerEmits)),{default:S(()=>[B(d,{url:t.url,"layer-name":t.layerName,headers:t.headers,"custom-parameters":t.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),N(t.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Q(ke,[["render",be]]);x.install=t=>{t.component(x.name||"VaMediaTileLayer",x)};const Ee="/test-api/layer/media",$t=v({__name:"basic",setup(t){const r=K(P),l={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},s=ee({url:Ee,layerName:"SSTD:D20240606-000001-P0",token:"866E0318465B47C5B252F6F306EFA00EZ8ZX8VPJQIPF9POV"}),p=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async o=>{const c=o.view;await o.layer.when();const y=o.layer.capabilities.extent;await c.when(),c.goTo(y)},n=te(0),u=o=>{n.value=o.zoom},m=o=>{console.log(o.result?.element.get("id"))};return(o,c)=>(b(),E(f(de),{"default-options":l},{before:S(()=>[I("p",null,[I("span",null,"当前缩放级别: "+ae(n.value),1)]),B(f(ye),{"label-width":100,"form-items":p,data:s,onSetData:c[0]||(c[0]=y=>f(he)(s,y))},null,8,["data"])]),default:S(()=>[B(f(fe),{type:"vec_c","spatial-reference":{wkid:4490}}),f(r)?re("",!0):(b(),E(f(x),{key:0,url:s.url,"layer-name":s.layerName,"custom-parameters":{layerId:s.layerName,token:s.token},headers:{token:s.token},onLoad:d,onClick:m,onRequest:u},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{$t as default};

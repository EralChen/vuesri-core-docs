import{a1 as d,a2 as p,ez as O,eA as A,a4 as $,an as N,at as S,eB as b,eC as x,eD as E,z as m,as as v,eE as R,bU as j,eF as _,eG as L,eH as q,eI as G,eJ as M,eK as c,eL as F,s as g,eM as w,bQ as Q,bI as I,eN as B}from"./chunk-CMhy9c9G.js";const T=P=>{let u=class extends P{constructor(...t){super(...t),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([N(()=>{const t=this.layer;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),S),b(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),b(()=>{const t=this.layer;return t&&"sublayers"in t?t.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?x(e,[...E(e,t.outFields),...r]):x(e,r)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){m.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(t){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new v(t);if("floorInfo"in this.layer&&this.layer.floorInfo){const r=R(this);r!=null&&(e.where=e.where?`(${e.where}) AND (${r})`:r)}return this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new v(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){return this._validateFetchPopupFeatures(t,e),this._fetchPopupFeatures(t,e)}_loadArcadeModules(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?j():Promise.resolve()}_handleRequiredFieldsChange(){const t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then(()=>{this._updatingRequiredFieldsPromise===t&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r,objectIdField:s}}=this,a="renderer"in e&&e.renderer,l="orderBy"in e&&e.orderBy,n="featureReduction"in e?e.featureReduction:null,i=new Set,h=await Promise.allSettled([a?a.collectRequiredFields(i,r):null,_(i,e),t&&"elevationInfo"in e?L(i,e):null,this.filter!=null?q(i,e,this.filter):null,t||this.featureEffect==null?null:q(i,e,this.featureEffect.filter),!t&&n?G(i,e,n):null,!t&&l?M(i,e,l):null]);if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&c(i,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"floorInfo"in e&&e.floorInfo&&c(i,e.fieldsIndex,[e.floorInfo.floorField]),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&m.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),c(i,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){F(i,r,e.subtypeField);const o=e.sublayers.map(y=>Promise.all([y.renderer?.collectRequiredFields(i,r),_(i,y)]));await Promise.allSettled(o)}if(e.type==="catalog-footprint"&&e.parent){const o=e.parent;c(i,r,[o.itemNameField,o.itemSourceField,o.itemTypeField,o.maxScaleField,o.minScaleField])}for(const o of h)o.status==="rejected"&&m.getLogger(this).error(o.reason);F(i,r,s),t&&"displayField"in e&&e.displayField&&F(i,r,e.displayField);const f=Array.from(i).sort();this._set("requiredFields",f)}_validateFetchPopupFeatures(t,e){if(e!=null)for(const r of t){const s=r.origin&&"layer"in r.origin?r.origin.layer:r.layer;if("popupEnabled"in s&&!s.popupEnabled)throw new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(r.isAggregate){const a="featureReduction"in s?s.featureReduction:null;if(!(a&&"popupTemplate"in a&&a.popupEnabled&&a.popupTemplate))throw new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!w(s,e))throw new g("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}_popupFeatureHasRequiredFields(t,e){return Q(e,t)}async _fetchPopupFeatures(t,e){const r=new Array(t.length),s=new Map,a=await this._createPopupQuery(t.map(l=>l.origin?.layer??l.layer),e);for(let l=0;l<t.length;l++){const n=t[l];if(n.isAggregate){r[l]=n;continue}const i=n.origin?.layer??n.layer;if(!i||!("popupEnabled"in i))continue;const h=E(this.layer.fieldsIndex,a.outFields),f=w(i,e);if(f==null)continue;const o=await this._loadArcadeModules(f);I(e),o&&o.arcadeUtils.hasGeometryOperations(f)||!this._popupFeatureHasRequiredFields(n,h)?s.set(n.getObjectId(),{graphic:n,index:l}):r[l]=n}if(this.layer.type==="stream"||this.layer.type==="parquet"||s.size===0)return r.filter(Boolean);a.objectIds=Array.from(s.keys());try{const l=await this.layer.queryFeatures(a,e);for(const n of l.features){const{graphic:{geometry:i,origin:h},index:f}=s.get(n.getObjectId());n.geometry||=i,n.origin=h,r[f]=n}}catch{}return r.filter(Boolean)}async _createPopupQuery(t,e){const r=this.layer.createQuery(),s=new Set;let a=!1;const l=t??[this.layer];for(const n of l){if(!("popupEnabled"in n))continue;const i=w(n,e);if(i==null)continue;const h=await this._loadArcadeModules(i);I(e);const f=h&&h.arcadeUtils.hasGeometryOperations(i);a=!(this.layer.geometryType!=="point"&&!f);const o=await B(this.layer,i);I(e);for(const y of o)s.add(y)}if(r.returnGeometry=a,r.returnZ=a,r.returnM=a,r.outFields=Array.from(s),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const n=R(this);n!=null&&(r.where=r.where?`(${r.where}) AND (${n})`:n)}return r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return d([p()],u.prototype,"_updatingRequiredFieldsPromise",void 0),d([p({readOnly:!0})],u.prototype,"availableFields",null),d([p({readOnly:!0})],u.prototype,"dataUpdating",void 0),d([p({type:O})],u.prototype,"featureEffect",null),d([p({type:A})],u.prototype,"filter",void 0),d([p()],u.prototype,"layer",void 0),d([p({type:Number})],u.prototype,"maximumNumberOfFeatures",null),d([p({readOnly:!0,type:Boolean})],u.prototype,"maximumNumberOfFeaturesExceeded",null),d([p({readOnly:!0})],u.prototype,"requiredFields",void 0),d([p()],u.prototype,"suspended",void 0),d([p()],u.prototype,"view",void 0),u=d([$("esri.views.layers.FeatureLayerView")],u),u};export{T as _};

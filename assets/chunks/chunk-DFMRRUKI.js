import{ng as Bt,nh as Tt,be as wt,bq as C,br as L,bn as Ct,bo as tt,bp as et,aH as Ut,a3 as Nt,iK as Ot,iJ as It,bu as U,iz as jt,iM as N,cz as Ft,iL as Gt,cy as Vt,fb as nt,b4 as j,cv as lt,fa as Mt,a_ as I,ni as Ht,nj as kt,s as Wt,nk as qt,nl as Zt,lg as Jt,iR as Kt,iH as K,nm as Qt,nn as ht,no as ut,np as pt,kD as Yt,y as Q,nq as Xt,cQ as te,bt as ee,nr as ne,ns as se,nt as ae,nu as ie,nv as oe,nw as dt,nx as re,ny as ce,nz as le,nA as he,nB as ue,cx as k,cD as gt,nC as pe,ht as X,jv as de,nD as ge,nE as me,nF as ye,nG as fe,jZ as be,iY as _e}from"./chunk-CMhy9c9G.js";import{t as xe,e as mt}from"./chunk-O5eRSE6e.js";import{a as Se}from"./chunk-DXKJyjzq.js";function Ge(t,e,s){const a=(e.length>0?e[0]:t.length/3)-1,n=Bt(t,a,s);if(n!==Tt.Z){t=t.slice();for(let i=0;i<t.length;i+=3)t[i+n]=t[i+2]}return wt(t,e,3)}function Ve(t){const e=[[C.POSITION,new L(t.attributeData.position,t.indices,3,!0)]],s=Ct(t.indices.length);return t.attributeData.colorFeature!=null?e.push([C.COLORFEATUREATTRIBUTE,new L([t.attributeData.colorFeature],s,1,!0)]):t.attributeData.color&&e.push([C.COLOR,new L(t.attributeData.color,s,4,!0)]),t.attributeData.uvMapSpace&&e.push([C.UVMAPSPACE,new L(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([C.BOUNDINGRECT,new L(t.attributeData.boundingRect,t.indices,9,!0)]),new tt(t.material,e,t.mapPositions,et.Mesh,t.attributeData.objectAndLayerIdColor)}function He(t,e=null){const s=[[C.POSITION,new L(t.attributeData.position,t.indices,3,!0)],[C.UV0,new L(t.attributeData.uv0,t.indices,2,!0)]];return new tt(t.material,s,t.mapPositions,et.Mesh,e)}function Pe(t){switch(t.type){case"extent":if(t instanceof Ut)return Nt.fromExtent(t);break;case"polygon":return t}return null}let ke=class{constructor(e,s,a){this.renderData=e,this.layerUid=s,this.graphicUid=a,this.outGeometries=new Array}};function Ee(t,e,s,a){const n=Ot(t.rings,!!t.hasZ&&a.mode!=="on-the-ground",It.CCW_IS_HOLE,t.spatialReference),i=U(n.position.length),o=jt(n.position,t.spatialReference,0,i,0,n.position,0,n.position.length/3,e,s,a),c=o!=null;return new Oe(n.position,i,At(n.polygons,n.position,i),vt(n.outlines,n.position,i),c,o)}function qe(t,e){const s=Ot(t.rings,!1,It.CCW_IS_HOLE),a=Ft(s.position,t.spatialReference,0,s.position,e,0);for(let n=2;n<s.position.length;n+=3)s.position[n]=Gt;return{position:s.position,polygons:At(s.polygons,s.position),outlines:vt(s.outlines,s.position),projectionSuccess:a}}function vt(t,e,s=null){return t.filter(({count:a})=>a>1).map(({index:a,count:n})=>{const i=3*a,o=3*n;return s!=null?new Dt(a,n,N(e,i,o),N(s,i,o)):new st(a,n,N(e,i,o))})}function At(t,e,s=null){const a=new Array;for(const{index:n,count:i,holeIndices:o,pathLengths:c}of t){if(i<=1)continue;const l=3*n,b=3*i,x=o.map(y=>y-n),_=s!=null?new we(n,i,N(e,3*n,3*i),N(s,l,b),x,c):new Ce(n,i,N(e,3*n,3*i),x,c);a.push(_)}return a}class st{constructor(e,s,a){this.index=e,this.count=s,this.position=a}}class Dt extends st{constructor(e,s,a,n){super(e,s,a),this.mapPositions=n}}class we extends Dt{constructor(e,s,a,n,i,o){super(e,s,a,n),this.holeIndices=i,this.pathLengths=o}}class Ce extends st{constructor(e,s,a,n,i){super(e,s,a),this.holeIndices=n,this.pathLengths=i}}class Oe{constructor(e,s,a,n,i,o){this.position=e,this.mapPositions=s,this.polygons=a,this.outlines=n,this.projectionSuccess=i,this.sampledElevation=o}}const Ie=["polygon","extent"];class Ze extends Ht{constructor(e,s,a,n){super(e,s,a,n),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const b=kt(this._getSymbolSize());if(b)throw new Wt("graphics3dextrudesymbollayer:invalid-size",b)}const e=this.symbolLayer?.material?.color,s=this._getCombinedOpacityAndColor(e),a=qt(s),n=s[3],i=n<1||this.needsDrivenTransparentPass,o=this.symbolLayer?.material?.emissiveFactor,c=o?Zt(Jt(o)):Kt,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:n,transparent:i,cullFace:i?K.None:K.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:c,offsetTransparentBackfaces:!0,normalType:Qt.Compressed};this._materials[A.Main]=new ht(l,this._context),this._materials[A.Bottom]=new ht({...l,cullFace:K.Back},this._context),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const s=e.graphic;if(!this._validateGeometry(s.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(s);return this._createAs3DShape(s,e.renderingInfo,a,n,s.uid)}layerOpacityChanged(e,s){const a=this.symbolLayer?.material?.color,n=this._getCombinedOpacity(a),i=n<1||this.needsDrivenTransparentPass;this._materials[A.Main]?.setParameters({opacity:n,transparent:i}),this._materials[A.Bottom]?.setParameters({opacity:n,transparent:i});const o=this._getLayerOpacity();e.forEach(c=>s(c)?.layerOpacityChanged(o,this._context.isAsync))}layerElevationInfoChanged(e,s){return this.updateGraphics3DGraphicElevationInfo(e,s,ut)}slicePlaneEnabledChanged(e,s){return this._materials[A.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[A.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(a=>{const n=s(a);n?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[A.Main]?.setParameters(e),this._materials[A.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let s;return s=e.size&&this._drivenProperties.size?Se(e.size,2)??0:this._getSymbolSize(),s/=this._context.renderCoordsHelper.unitInMeters,s}applyRendererDiff(e,s){return this._drivenPropertiesChanged(s)?pt.RecreateSymbol:pt.RecreateGraphics}async queryForSnapping(e,s,a,n){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Yt(s),{objectId:o,target:c}=e,l=Q(c);switch(l.z=(l.z??0)+i,e.type){case"edge":{const{start:b,end:x}=e,_=Q(b),y=Q(x);return _.z=(_.z??0)+i,y.z=(y.z??0)+i,[mt(o,l,1/0,_,y)]}case"vertex":return[xe(o,l,1/0),mt(o,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,s,a,n,i){const o=Pe(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(M=>M.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const c=Ee(o,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(c,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Xt(o);if(l==null)return null;const b=new Array,x=new Array,_=te(),y=X(),P=I(),h=this._context.renderCoordsHelper.viewingMode===ee.Global;h||this._context.renderCoordsHelper.worldUpAtPosition(null,P),ne(o.spatialReference,[l.x,l.y,0],y,this._context.renderCoordsHelper.spatialReference);const g=X();se(g,y);const d=de();ae(d,g);const{polygons:f,mapPositions:p,position:m}=c,u=new Map,S=this._materials[A.Main];for(const M of f){const R=M.count;if(this._context.clippingExtent&&(ie(M.mapPositions,_),!oe(_,this._context.clippingExtent)))continue;const $=wt(M.mapPositions,M.holeIndices,3);if($.length===0)continue;const z=$.length,B=6*R,W=dt(B+z),q=dt(z),G=U(3*B),at=U(3*B),it=U(3*B),ot=U(B);Me(m,p,$,M,G,it,at,ot,W,q,this._getExtrusionSize(s),P,h),re(G,G,g);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),Z=new Te(G,it,ce(at),ot),J=yt(S,W,W.length-q.length,Z,a,rt),Rt=R,$t=R,zt=2*M.count,ct=new Ue(Rt,$t,zt,z/3);Lt(J,ct,y),u.set(J,ct),b.push(J,yt(this._materials[A.Bottom],q,0,Z,a,rt)),x.push(Z.heights)}if(b.length===0)return null;const r=new le({geometries:b,layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0});r.transformation=y;const E=he(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=E?new ue(this._materials[A.Main],E,this._context.slicePlaneEnabled):null,D=new ge(this,r,b,null,null,(M,R,$,z,B)=>De(M,R,$,z,B,x,u),n,w);return D.alignedSampledElevation=c.sampledElevation,D.needsElevationUpdates=ut(n.mode),D}}function yt(t,e,s,a,n,i){const o=Ct(e.length),c=[[C.POSITION,new L(a.positions,e,3,!0)],[C.NORMALCOMPRESSED,new L(a.normals,e,2,!0)],[C.COLOR,new L(n,o,4,!0)]];return new tt(t,c,a.elevation,et.Mesh,i,s)}function Me(t,e,s,a,n,i,o,c,l,b,x,_,y){{const P=s.length/3,h=2*a.count;ve(t,e,a.index,a.count,s,0,P,n,i,o,c,l,b,h,x,_,y)}{let P=0,h=2*a.count,g=0;const d=a.pathLengths[0];ft(n,i,c,o,P,d,a.count,h,l,g,x),h+=4*d,g+=2*d,P+=d;for(let f=1;f<a.pathLengths.length;++f){const p=a.pathLengths[f];ft(n,i,c,o,P,p,a.count,h,l,g,x),h+=4*p,g+=2*p,P+=p}}}function ve(t,e,s,a,n,i,o,c,l,b,x,_,y,P,h,g,d){Vt(v,g);{const f=h>0?1:-1;let p=3*s,m=0,u=3*m,S=a,r=3*S;for(let E=0;E<a;++E){const w=t[p],D=t[p+1],M=t[p+2];d&&(v[0]=w,v[1]=D,v[2]=M,nt(v,v)),c[u+0]=w,c[u+1]=D,c[u+2]=M;const R=e[p+0],$=e[p+1],z=e[p+2];l[u+0]=R,l[u+1]=$,l[u+2]=z,b[u+0]=-f*v[0],b[u+1]=-f*v[1],b[u+2]=-f*v[2],x[m]=0,c[r+0]=w+h*v[0],c[r+1]=D+h*v[1],c[r+2]=M+h*v[2],l[r+0]=R,l[r+1]=$,l[r+2]=z,x[S]=h,u+=3,r+=3,p+=3,m+=1,S+=1}}{let f=3*i,p=0,m=3*P;const u=h<0?Et:Pt,S=h<0?Pt:Et;for(let r=0;r<o;++r)y[p]=n[f+u[0]],y[p+1]=n[f+u[1]],y[p+2]=n[f+u[2]],_[m]=n[f+S[0]]+a,_[m+1]=n[f+S[1]]+a,_[m+2]=n[f+S[2]]+a,p+=3,m+=3,f+=3}}function V(t,e,s,a,n,i,o){a[i]=a[o],o*=3,t[i*=3]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],e[i]=e[o],e[i+1]=e[o+1],e[i+2]=e[o+2],s[i]=n[0],s[i+1]=n[1],s[i+2]=n[2]}const F=I();function ft(t,e,s,a,n,i,o,c,l,b,x){let _=n,y=n+1,P=n+o,h=n+o+1,g=c,d=c+1,f=c+2*i,p=c+2*i+1;x<0&&(_=n+o+1,h=n);let m=3*b;for(let u=0;u<i;++u)u===i-1&&(y=n,x>0?h=n+o:_=n+o),Ae(t,_,y,P,F),V(t,e,a,s,F,g,_),V(t,e,a,s,F,d,y),V(t,e,a,s,F,f,P),V(t,e,a,s,F,p,h),l[m]=g,l[m+1]=f,l[m+2]=p,l[m+3]=g,l[m+4]=p,l[m+5]=d,m+=6,_++,y++,P++,h++,g+=2,d+=2,f+=2,p+=2}const Y=I(),bt=I(),_t=I(),xt=I(),St=I();function Ae(t,e,s,a,n){e*=3,s*=3,a*=3,j(Y,t[e++],t[e++],t[e++]),j(bt,t[s++],t[s++],t[s++]),j(_t,t[a++],t[a++],t[a++]),lt(xt,bt,Y),lt(St,_t,Y),Mt(n,St,xt),nt(n,n)}const T=I();function De(t,e,s,a,n,i,o){const c=t.stageObject,l=c.geometries,b=l.length,x=e.mode!=="absolute-height";let _=0;const y=c.transformation,P=me(X(),y);for(let h=0;h<b;h+=2){const g=l[h];if(!ye(g))continue;const d=g.getMutableAttribute(C.POSITION).data,f=i[h/2],p=new fe(g.mapPositions),m=d.length/3;let u=!1,S=0;{let r=0;for(let E=0;E<m;E++){T[0]=d[r],T[1]=d[r+1],T[2]=d[r+2],a(p,H),x&&(S+=H.sampledElevation),be.TESTS_DISABLE_OPTIMIZATIONS?(j(O,p.array[p.offset],p.array[p.offset+1],H.z+f[r/3]),s!=null&&n.toRenderCoords(O,s,O),k(O,O,P)):(j(O,d[r],d[r+1],d[r+2]),k(O,O,y),n.setAltitude(O,H.z+f[r/3]),k(O,O,P)),d[r]=O[0],d[r+1]=O[1],d[r+2]=O[2];const w=Le/n.unitInMeters;(Math.abs(T[0]-d[r])>=w||Math.abs(T[1]-d[r+1])>=w||Math.abs(T[2]-d[r+2])>=w)&&(u=!0),p.offset+=3,r+=3}}if(u){const r=o.get(g);r&&Lt(g,r,y),c.geometryVertexAttributeUpdated(l[h],C.NORMALCOMPRESSED),g.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[h],C.POSITION),l[h+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[h+1],C.POSITION)}_+=S/m}return _/b}function Lt(t,e,s){const a=t.getMutableAttribute(C.POSITION),n=t.getMutableAttribute(C.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:o,topFaceStart:c,topFaceCount:l}=e,b=a.data,x=o,_=t.attributes.get(C.POSITION).indices,y=c+l,P=i+o,h=U(3*x);for(let u=0;u<x;++u){const S=3*u;h[S+0]=0,h[S+1]=0,h[S+2]=0}const g=Re,d=$e,f=ze,p=Be,m=v;for(let u=c;u<y;++u){const S=3*u;for(let r=0;r<3;++r){const E=_[S+r];p[r]=E;const w=3*E;j(O,b[w+0],b[w+1],b[w+2]),k(g[r],O,s)}gt(d,g[1],g[0]),gt(f,g[2],g[0]),Mt(m,d,f),nt(m,m);for(let r=0;r<3;++r){const E=3*(p[r]-i);h[E+0]+=m[0],h[E+1]+=m[1],h[E+2]+=m[2]}}for(let u=i;u<P;++u){const S=3*(u-i),r=h[S+0],E=h[S+1],w=h[S+2],D=Math.sqrt(r*r+E*E+w*w);pe(n,u,r/D,E/D,w/D)}}const O=I(),v=I(),H=new _e,Pt=[0,2,1],Et=[0,1,2],Le=.01,Re=[I(),I(),I()],$e=I(),ze=I(),Be=[0,0,0];var A;(function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"})(A||(A={}));class Te{constructor(e,s,a,n){this.positions=e,this.elevation=s,this.normals=a,this.heights=n}}class Ue{constructor(e,s,a,n){this.topVertexStart=e,this.topVertexCount=s,this.topFaceStart=a,this.topFaceCount=n}}export{Ge as a,Pe as b,qe as c,ke as g,He as l,Ve as m,Me as n,Ze as o,Ee as p};

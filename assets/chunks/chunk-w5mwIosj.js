import{br as R,gY as L,hb as N,hd as C,lt as _,oz as Z,gW as j,oE as $,dg as G,mI as W,hm as H,lD as Q,h7 as I,g$ as b,h0 as E,h3 as S,h5 as B,lF as Y,oB as J,tR as K,h6 as ee,h2 as te,he as ae,h9 as O,h1 as f,hi as re}from"./chunk-Id6bT2Sz.js";import{e as ne,u as oe,V as se,c as ie}from"./chunk-QihfDstr.js";import{V as me,b as le,u as pe}from"./chunk-YYgKY7N-.js";import{u as ue}from"./chunk-Hg0ijuo1.js";import{R as ce}from"./chunk-KpbMssn-.js";import{V as de}from"./chunk-VYQ-U2se.js";import"./chunk-4hjVwnSY.js";import"./chunk-jI3QkYCl.js";import"./chunk-YAIfb7rT.js";import"./chunk-zyV5aIGZ.js";import"./chunk-aEd827qQ.js";import"./chunk-JSmmlvVF.js";import"./chunk-j-GHia9k.js";import{V as fe}from"./chunk-1MLrZeeG.js";import"./chunk-5CojvStp.js";import"./chunk-xuI8tR0Q.js";import"./chunk-Wdy-tSn2.js";import"./chunk-igrRTtQJ.js";import"./chunk-E3AbFWGF.js";import"./chunk-Jl-T-yZh.js";import"./chunk-0hY-FzC-.js";import"./chunk-knBODP9n.js";import"./chunk-wjQBD1Yx.js";import"./chunk-Ocl6_GDd.js";import"./chunk-dLiZYYWx.js";import"./chunk-Xm0ceK_d.js";import"./chunk-jXTtycZ1.js";import"./chunk-OgyxI9kt.js";import"./chunk-2k2kSzxb.js";import"./chunk-JHqeRKeh.js";import"./chunk-M66e94sa.js";import"./chunk-VBKEdNlL.js";import"./chunk-Lk3b00l-.js";import"./chunk-sT2yXiVE.js";import"./chunk-XBmnoeIS.js";import"./chunk-C8VrzzNg.js";import"./chunk-BCh6XKoX.js";import"./chunk-O_CfKMPd.js";import"./chunk-vtvKCmTS.js";import"./chunk-LcTX_s1x.js";import"./chunk-7GJMvv7k.js";import"./chunk-3ylXphSj.js";import{V as ye,s as he}from"./chunk-qeB46JvM.js";import"./chunk-c63RqAWR.js";import"./chunk-f83L__eB.js";import"./chunk-KpKdxowh.js";import"./chunk-B3AFDltd.js";import"./chunk-4YICMpBk.js";import"./chunk-SV1sIRwr.js";import"./chunk-qATmn6PQ.js";import"./chunk-H-OygxC9.js";import"./chunk-zE2npswH.js";import"./chunk-QchhmuGV.js";import"./chunk-St7f5jWn.js";import"./chunk-6-KQpLc7.js";import"./chunk-bd1jBHeZ.js";import"./chunk-QTAaumgd.js";import"./chunk-v3Gufcwv.js";import"./chunk-Y93dcB9q.js";import"./chunk-65DhI__o.js";import"./chunk-ROaYpYVY.js";import"./chunk-JE2bSXwA.js";import"./chunk-zf8qcgyw.js";import"./chunk-9Fz4MECv.js";import"./chunk-j2dthR7G.js";import"./chunk-NSlzfvGq.js";const we={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},xe={...ne,load:e=>e,request:e=>e};function q(e,r,a="id"){const l=[],s=r.reduce((u,m)=>{const o=m[a];return u.set(o,m),u},new Map),p=e.reduce((u,m)=>{const o=m[a];return s.has(o)?(l.push(m),s.delete(o)):u.set(o,m),u},new Map),d=[...s.values()],n=[...p.values()];return{addMap:s,deleteMap:p,updateRows:l,addRows:d,deleteRows:n}}const P=new ce({baseURL:""}),Re=async(e,r,a={},l={})=>P.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...l}),ge=async(e,r,a={},l={})=>P.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...l}),ke=L({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=oe(),l=p(),s=a.when.bind(a);a.when=(...n)=>l.then(()=>s(...n));function p(){return ge(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent=new R(n.extent),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const u=n.headers;for(const m in r.headers)u.set(m,r.headers[m]);return n}return(n,u)=>N(n.$slots,"default")}}),Ve=L({name:"VaMediaTileLayer",components:{VaMediaLayer:se,Capabilities:ke},props:we,emits:xe,setup(e,{emit:r}){const a=ue(),l=Math.random().toString(36).substring(2,9),s=ie(r,["load"]),p=new me({elements:[]}),d=C(),n=C(),u=t=>{t.layer.when(()=>{d.value=t.layer}),t.layer.on("layerview-create",i=>{n.value=i.layerView}),$(()=>{r("load",t)})},m=t=>{n.value&&G(()=>!n.value?.updating).then(t)},o=new W,c=_({SERVICE:"ZZTS"}),y=()=>{c.LAYER=e.layerName,c.SCALE=a.scale;let t=a.extent;(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=H(a.extent));const i=t;c.BBOX=new R({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}}),c.HEIGHT=a.height,c.WIDTH=a.width},A=a.watch("stationary",t=>{t&&T()});o.add(A);const U=Z(T,800),z=a.on("drag",()=>{U()});o.add(z),j(()=>{o.removeAll()});const v=_({zoom:0});function M(t){t.length!==0&&m(()=>p.elements.addMany(t))}function T(){y(),D()}function D(){if(e.url)return Re(e.url,c,e.customParameters,{queue:{id:l,mode:"abort"},setRequestInit:X}).then(async t=>{r("request",t);const i=p.elements.toArray();let h=!1,g=[];t.zoom!==v.zoom&&(h=!0,g=i),v.zoom=t.zoom;const k=[];for(const V of t.elements){const w=F(V);w&&k.push(w)}if(h)M(k);else{const{addRows:V,deleteRows:w}=q(i,k,"id");M(V),g=w}return g}).then(t=>{setTimeout(()=>{const{updateRows:i}=q(p.elements.toArray(),t,"id");i.length!==0&&(n.value?.updating||m(()=>p.elements.removeMany(i)))},400)})}function F(t){if(t.type==="image"){const i=new le({image:t.url,georeference:new pe({extent:{...t.extent,spatialReference:{wkid:4326}}})});return i.id=t.id,i}}function X(t){const i=t.headers;for(const h in e.headers)i.set(h,e.headers[h]);return t}return{layerLoad:u,source:p,layerEmits:s}}});function be(e,r,a,l,s,p){const d=I("Capabilities"),n=I("VaMediaLayer");return b(),E(n,Y({source:e.source,onLoad:e.layerLoad},J(e.layerEmits)),{default:S(()=>[B(d,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),N(e.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Q(Ve,[["render",be]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const Ee="/test-api/layer/media",$t=L({__name:"basic",setup(e){const r=K($),l={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},s=ee({url:Ee,layerName:"SSTD:D20240606-000026-P0",token:"135314C27E52464FA3BF735694585238IJFZ9YSIMIB0V0QL"}),p=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async o=>{const c=o.view;await o.layer.when();const y=o.layer.capabilities.extent;await c.when(),c.goTo(y)},n=te(0),u=o=>{n.value=o.zoom},m=o=>{console.log(o.result?.element.get("id"))};return(o,c)=>(b(),E(f(de),{"default-options":l},{before:S(()=>[O("p",null,[O("span",null,"当前缩放级别: "+ae(n.value),1)]),B(f(ye),{"label-width":100,"form-items":p,data:s,onSetData:c[0]||(c[0]=y=>f(he)(s,y))},null,8,["data"])]),default:S(()=>[B(f(fe),{type:"vec_c","spatial-reference":{wkid:4490}}),f(r)?re("",!0):(b(),E(f(x),{key:0,url:s.url,"layer-name":s.layerName,"custom-parameters":{layerId:s.layerName,token:s.token},headers:{token:s.token},onLoad:d,onClick:m,onRequest:u},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{$t as default};

import{br as R,gY as C,hb as N,hd as M,lt as _,oz as F,gW as W,oE as $,dg as Z,mI as G,hm as H,lD as Q,h7 as O,g$ as b,h0 as E,h3 as B,h5 as S,lF as Y,oB as J,tR as K,h6 as ee,h2 as te,he as ae,h9 as I,h1 as f,hi as re}from"./chunk-nmd5K2Af.js";import{e as ne,u as oe,V as se,c as ie}from"./chunk-wHDIgYQO.js";import{V as me,b as le,u as pe}from"./chunk-gPnlrcM9.js";import{u as ue}from"./chunk-SsoqVI4I.js";import{R as ce}from"./chunk-KpbMssn-.js";import{V as de}from"./chunk-InKMq42H.js";import"./chunk-GaG15Itw.js";import"./chunk-6F8PGj_N.js";import"./chunk-oVxik0y1.js";import"./chunk-rOF-vNB8.js";import"./chunk-t7EiKpca.js";import"./chunk-4NAPaaGI.js";import"./chunk-MTVCPng0.js";import{V as fe}from"./chunk-Gt32dAh7.js";import"./chunk-OPsix7RJ.js";import"./chunk-QdT98bGi.js";import"./chunk-lBbcFwEz.js";import"./chunk-FsgSXnn4.js";import"./chunk-MnHm3upY.js";import"./chunk-v0lT8rQM.js";import"./chunk-k735tXex.js";import"./chunk-in1gTCUd.js";import"./chunk-n5kUsNGU.js";import"./chunk-xyX103Ld.js";import"./chunk-hhhbp20X.js";import"./chunk-xHN5038P.js";import"./chunk-tuMVhgFT.js";import"./chunk-QIwe_mAc.js";import"./chunk-ZtTlIuKc.js";import"./chunk-IXHV0Ry1.js";import"./chunk-35LgOlc_.js";import"./chunk-XaHE2vv1.js";import"./chunk-5DKHLsAU.js";import"./chunk-AYfuDapK.js";import"./chunk-VyqVUuoU.js";import"./chunk-rWf70Ob4.js";import"./chunk-1mB-ltZP.js";import"./chunk-Ev-Bno0l.js";import"./chunk-MQ0kwtJ4.js";import"./chunk-7Wg9pkoQ.js";import"./chunk-DONjpVNo.js";import"./chunk-MvMCq-oQ.js";import{V as ye,s as he}from"./chunk-dSJVCjL6.js";import"./chunk-XYpg21u-.js";import"./chunk-vBrfeuUR.js";import"./chunk-_oFyxSRx.js";import"./chunk-B3AFDltd.js";import"./chunk-2Nnh7Nz_.js";import"./chunk-ljfhnYgQ.js";import"./chunk-N3ZHh-oN.js";import"./chunk-WRHPgpcP.js";import"./chunk-Ie-fb-om.js";import"./chunk-yFotnayi.js";import"./chunk-OeG6hE0O.js";import"./chunk-IivQlB-q.js";import"./chunk-I2AbkaLk.js";import"./chunk-OhQvwaUL.js";import"./chunk-ESmddae3.js";import"./chunk-SrPYhnCK.js";import"./chunk-YEz4U7Qa.js";import"./chunk-sFsCJIsO.js";import"./chunk-oYnoOGkk.js";import"./chunk-Xd7Q5ZQD.js";import"./chunk-qi8cOMSh.js";import"./chunk-C1Zy5GV4.js";import"./chunk-v_TIPWMu.js";const we={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},xe={...ne,load:e=>e,request:e=>e};function q(e,r,a="id"){const l=[],s=r.reduce((u,m)=>{const o=m[a];return u.set(o,m),u},new Map),p=e.reduce((u,m)=>{const o=m[a];return s.has(o)?(l.push(m),s.delete(o)):u.set(o,m),u},new Map),d=[...s.values()],n=[...p.values()];return{addMap:s,deleteMap:p,updateRows:l,addRows:d,deleteRows:n}}const A=new ce({baseURL:""}),Re=async(e,r,a={},l={})=>A.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...l}),ge=async(e,r,a={},l={})=>A.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...l}),ke=C({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=oe(),l=p(),s=a.when.bind(a);a.when=(...n)=>l.then(()=>s(...n));function p(){return ge(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent=new R(n.extent),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const u=n.headers;for(const m in r.headers)u.set(m,r.headers[m]);return n}return(n,u)=>N(n.$slots,"default")}}),Ve=C({name:"VaMediaTileLayer",components:{VaMediaLayer:se,Capabilities:ke},props:we,emits:xe,setup(e,{emit:r}){const a=ue(),l=Math.random().toString(36).substring(2,9),s=ie(r,["load"]),p=new me({elements:[]}),d=M(),n=M(),u=t=>{t.layer.when(()=>{d.value=t.layer}),t.layer.on("layerview-create",i=>{n.value=i.layerView}),$(()=>{r("load",t)})},m=t=>{n.value&&Z(()=>!n.value?.updating).then(t)},o=new G,c=_({SERVICE:"ZZTS"}),y=()=>{c.LAYER=e.layerName,c.SCALE=a.scale;let t=a.extent;(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=H(a.extent));const i=t;c.BBOX=new R({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}}),c.HEIGHT=a.height,c.WIDTH=a.width},P=a.watch("stationary",t=>{t&&L()});o.add(P);const D=F(L,800),U=a.on("drag",()=>{D()});o.add(U),W(()=>{o.removeAll()});const T=_({zoom:0});function v(t){t.length!==0&&m(()=>p.elements.addMany(t))}function L(){y(),X()}function X(){if(e.url)return Re(e.url,c,e.customParameters,{queue:{id:l,mode:"abort"},setRequestInit:j}).then(async t=>{r("request",t);const i=p.elements.toArray();let h=!1,g=[];t.zoom!==T.zoom&&(h=!0,g=i),T.zoom=t.zoom;const k=[];for(const V of t.elements){const w=z(V);w&&k.push(w)}if(h)v(k);else{const{addRows:V,deleteRows:w}=q(i,k,"id");v(V),g=w}return g}).then(t=>{setTimeout(()=>{const{updateRows:i}=q(p.elements.toArray(),t,"id");i.length!==0&&(n.value?.updating||m(()=>p.elements.removeMany(i)))},400)})}function z(t){if(t.type==="image"){const i=new le({image:t.url,georeference:new pe({extent:{...t.extent,spatialReference:{wkid:4326}}})});return i.id=t.id,i}}function j(t){const i=t.headers;for(const h in e.headers)i.set(h,e.headers[h]);return t}return{layerLoad:u,source:p,layerEmits:s}}});function be(e,r,a,l,s,p){const d=O("Capabilities"),n=O("VaMediaLayer");return b(),E(n,Y({source:e.source,onLoad:e.layerLoad},J(e.layerEmits)),{default:B(()=>[S(d,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),N(e.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Q(Ve,[["render",be]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const Ee="/test-api/layer/media",$t=C({__name:"basic",setup(e){const r=K($),l={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},s=ee({url:Ee,layerName:"SSTD:D20240519-000006-P0",token:"565A1FCFA0B14290A9B685B6597B4EDBQXV1ETSCY8WIC9P8"}),p=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async o=>{const c=o.view;await o.layer.when();const y=o.layer.capabilities.extent;await c.when(),c.goTo(y)},n=te(0),u=o=>{n.value=o.zoom},m=o=>{console.log(o.result?.element.get("id"))};return(o,c)=>(b(),E(f(de),{"default-options":l},{before:B(()=>[I("p",null,[I("span",null,"当前缩放级别: "+ae(n.value),1)]),S(f(ye),{"label-width":100,"form-items":p,data:s,onSetData:c[0]||(c[0]=y=>f(he)(s,y))},null,8,["data"])]),default:B(()=>[S(f(fe),{type:"vec_c","spatial-reference":{wkid:4490}}),f(r)?re("",!0):(b(),E(f(x),{key:0,url:s.url,"layer-name":s.layerName,"custom-parameters":{layerId:s.layerName,token:s.token},headers:{token:s.token},onLoad:d,onClick:m,onRequest:u},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{$t as default};

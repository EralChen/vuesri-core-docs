import{i as $}from"./chunk-CvLOc7fe.js";import{gQ as P,gR as k,gS as _,gT as E,gU as F}from"./chunk-CGsGeN7j.js";import"./chunk-ByM7454y.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */const G=96/72;class wt{constructor(g){this._spatialReference=g,this._imageDataCanvas=null,this._cimResourceManager=new $}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(g,u,w,f,o,i,s,n,M){if(!g)return null;const{data:h}=g;if(!h||h.type!=="CIMSymbolReference"||!h.symbol)return null;const{symbol:R}=h;i||(i=P(R));const r=await k.resolveSymbolOverrides(h,u,this._spatialReference,o,i,s,n),c=this._cimResourceManager,d=[];_.fetchResources(r,c,d),_.fetchFonts(r,c,d),d.length>0&&await Promise.all(d);const{width:e,height:a}=w,C=D(i,e,a,f),t=_.getEnvelope(r,C,c);if(!t)return null;let m=1,S=0,v=0;switch(R.type){case"CIMPointSymbol":case"CIMTextSymbol":{let l=1;t.width>e&&(l=e/t.width);let y=1;t.height>a&&(y=a/t.height),f==="preview"&&(t.width<e&&(l=e/t.width),t.height<a&&(y=a/t.height)),m=Math.min(l,y),S=t.x+t.width/2,v=t.y+t.height/2}break;case"CIMLineSymbol":{(M||t.height>a)&&(m=a/t.height),v=t.y+t.height/2;const l=t.x*m+e/2,y=(t.x+t.width)*m+e/2,{paths:b}=C;b[0][0][0]-=l/m,b[0][2][0]-=(y-e)/m}break;case"CIMPolygonSymbol":{S=t.x+t.width/2,v=t.y+t.height/2;const l=t.x*m+e/2,y=(t.x+t.width)*m+e/2,b=t.y*m+a/2,I=(t.y+t.height)*m+a/2,{rings:p}=C;l<0&&(p[0][0][0]-=l,p[0][3][0]-=l,p[0][4][0]-=l),b<0&&(p[0][0][1]+=b,p[0][1][1]+=b,p[0][4][1]+=b),y>e&&(p[0][1][0]-=y-e,p[0][2][0]-=y-e),I>a&&(p[0][2][1]+=I-a,p[0][3][1]+=I-a)}}const z={type:"cim",data:{type:"CIMSymbolReference",symbol:r}};return this.rasterize(z,e,a,S,v,m,i,1,C)}rasterize(g,u,w,f,o,i,s,n=0,M=null){const{data:h}=g;if(!h||h.type!=="CIMSymbolReference"||!h.symbol)return null;const{symbol:R}=h,r=this._canvas,c=(window.devicePixelRatio||1)*G;r.width=u*c,r.height=w*c,s||(s=P(R)),M||(M=D(s,u,w,"legend")),r.width+=2*n,r.height+=2*n;const d=r.getContext("2d",{willReadFrequently:!0}),e=F.createIdentity();return e.translate(-f,-o),e.scale(i*c,-i*c),e.translate(u*c/2+n,w*c/2+n),d.clearRect(0,0,r.width,r.height),new E(d,this._cimResourceManager,e,!0).drawSymbol(R,M),d.getImageData(0,0,r.width,r.height)}}function D(x,g,u,w){const o=-g/2+1,i=g/2-1,s=u/2-1,n=-u/2+1;switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[i,0]]]};default:return w==="legend"?{rings:[[[o,s],[i,0],[i,n],[o,n],[o,s]]]}:{rings:[[[o,s],[i,s],[i,n],[o,n],[o,s]]]}}}export{wt as CIMSymbolRasterizer};

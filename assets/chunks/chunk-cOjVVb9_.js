import{cJ as R,gZ as v,hc as O,he as U,t_ as X,lz as M,gX as z,g_ as Z,oH as q,bL as j,lQ as H,ho as G,lF as W,h8 as _,h0 as V,h1 as g,h4 as S,h6 as L,hi as Q,oF as Y,t$ as J,h7 as K,h3 as ee,hf as te,ha as N,h2 as y,hk as re}from"./chunk-5cgByRBI.js";import{e as ae,u as ne,V as oe,c as se}from"./chunk-8qjBjNgv.js";import{V as ie,b as me,u as le}from"./chunk-ABk-8O9b.js";import{u as ue}from"./chunk-AKK1CEJt.js";import{R as pe}from"./chunk-YAzdkTjJ.js";import{V as ce}from"./chunk-Px56PspP.js";import"./chunk-E5BRPeYu.js";import"./chunk-pCqGjxAI.js";import"./chunk-zSey9Ooj.js";import"./chunk-h-6BO8IB.js";import"./chunk-xAN4VzPO.js";import"./chunk-UKZSLdqr.js";import"./chunk-WSF21JF0.js";import{V as de}from"./chunk-yZafP3rf.js";import"./chunk-H62H84bQ.js";import"./chunk-x_uP2gs7.js";import"./chunk-CuAaMpbW.js";import"./chunk-9fCAoXev.js";import"./chunk-at0AWBwu.js";import"./chunk-ahoVFfdr.js";import"./chunk-vVb9o76x.js";import"./chunk-xrk-kNOH.js";import"./chunk-pwJAAE4U.js";import"./chunk-n27tu1zc.js";import"./chunk-O7qZ5nAO.js";import"./chunk-Ow-0ZicZ.js";import"./chunk-n41jAy5X.js";import"./chunk-puQ8N500.js";import"./chunk-DLXyH4A4.js";import"./chunk-Kr9URs_A.js";import"./chunk-EL967GvW.js";import"./chunk-sPUU7m6j.js";import"./chunk-vI5OQCLh.js";import"./chunk-TdOen-x3.js";import"./chunk-FmJXFfP7.js";import"./chunk-e_xIS2Vw.js";import"./chunk-bCfOp0ta.js";import"./chunk-3EAHv1mu.js";import"./chunk-d0kHfygp.js";import"./chunk-Ysh6IYsX.js";import"./chunk-z09cFCry.js";import"./chunk-tdkwsFTd.js";import{V as fe,s as ye}from"./chunk-DGzo3AFt.js";import"./chunk-ZKUTSqCA.js";import"./chunk-_HEdEAnB.js";import"./chunk-P-mZngti.js";import"./chunk-B3AFDltd.js";import"./chunk-GGNru00e.js";import"./chunk-oS8TyLWd.js";import"./chunk-a-xr3J5F.js";import"./chunk-bwcopS2E.js";import"./chunk-ZeagjGhH.js";import"./chunk-bHygnf-z.js";import"./chunk-jBkAkGOX.js";import"./chunk-JsLoWACQ.js";import"./chunk-egdxQktw.js";import"./chunk-HIFxgyK4.js";import"./chunk-TTXlCCZW.js";import"./chunk-aO_7W1pF.js";import"./chunk-zcGkV3CJ.js";import"./chunk-Hd4L5YxN.js";import"./chunk-wlAG3hwf.js";import"./chunk-AiqscqsX.js";import"./chunk-mnNLVLmE.js";import"./chunk-fAQUSyrm.js";const he={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3}},we={...ae,load:e=>e,request:e=>e};function I(e,a,r="id"){const u=[],o=a.reduce((p,l)=>{const i=l[r];return p.set(i,l),p},new Map),m=e.reduce((p,l)=>{const i=l[r];return o.has(i)?(u.push(l),o.delete(i)):p.set(i,l),p},new Map),d=[...o.values()],n=[...m.values()];return{addMap:o,deleteMap:m,updateRows:u,addRows:d,deleteRows:n}}const A=new pe({baseURL:""}),xe=async(e,a,r={},u={})=>A.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+a.BBOX.spatialReference.wkid,...a,BBOX:[a.BBOX.xmin,a.BBOX.ymin,a.BBOX.xmax,a.BBOX.ymax].join(","),...r},...u}).then(o=>(o.elements.forEach(m=>{m.id=a.LAYER+"_"+m.id}),o)),Re=async(e,a,r={},u={})=>A.request({baseURL:e,method:"GET",url:"",params:{...a,...r},...u}),Ee=v({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const a=e,r=ne(),u=m(),o=r.when.bind(r);r.when=(...n)=>u.then(()=>o(...n));function m(){return Re(a.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:a.layerName},a.customParameters,{setRequestInit:d}).then(n=>{n.extent&&(n.extent=new R(n.extent)),r.maxScale=n.maxScale,r.minScale=n.minScale,r.capabilities=n,r.capabilitiesResponse=n})}function d(n){const p=n.headers;for(const l in a.headers)p.set(l,a.headers[l]);return n}return(n,p)=>O(n.$slots,"default")}}),be=v({name:"VaMediaTileLayer",components:{VaMediaLayer:oe,Capabilities:Ee},props:he,emits:we,setup(e,{emit:a}){const r=ue(),u=Math.random().toString(36).substring(2,9),o=se(a,["load"]),m=new ie({elements:[]}),d=U(),n=X(),p=t=>{t.layer.when(()=>{d.value=t.layer}),t.layer.on("layerview-create",s=>{n.resolve(s.layerView)}),q(()=>{a("load",t)})},l=async t=>{const s=await n.promise;j(()=>!s.updating).then(t)},i=new H,c=M({SERVICE:"ZZTS"}),f=()=>{c.LAYER=e.layerName,c.SCALE=r.scale;let t=r.extent;t&&(r.extent.spatialReference.wkid===102100||r.extent.spatialReference.wkid===3857)&&(t=G(r.extent));const s=t;s&&(c.BBOX=new R({xmin:s.xmin,ymin:s.ymin,xmax:s.xmax,ymax:s.ymax,spatialReference:{wkid:4326}})),c.HEIGHT=r.height,c.WIDTH=r.width},D=r.watch("stationary",t=>{t&&C()});i.add(D),z(()=>{i.removeAll()});const B=M({zoom:0});function T(t){t.length!==0&&l(()=>m.elements.addMany(t))}function C(){r.when(()=>{f(),$()})}function $(){if(e.url)return xe(e.url,c,e.customParameters,{queue:{id:u,mode:"abort"},setRequestInit:P}).then(async t=>{a("request",t);const s=m.elements.toArray();let h=!1,E=[];t.zoom!==B.zoom&&(h=!0,E=s),B.zoom=t.zoom;const b=[];if(t.elements){for(const k of t.elements){const w=F(k);w&&b.push(w)}if(h)T(b);else{const{addRows:k,deleteRows:w}=I(s,b,"id");T(k),E=w}return E}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:s}=I(m.elements.toArray(),t,"id");s.length!==0&&(n.value?.updating||l(()=>m.elements.removeMany(s)))},400)}).catch(t=>{t.name!=="AbortError"&&console.error(t)})}Z(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{C()},{immediate:!0,deep:!0});function F(t){if(t.type==="image"){const s=new me({image:t.url,georeference:new le({extent:{...t.extent,spatialReference:{wkid:4326}}})});return s.id=t.id,s}}function P(t){const s=t.headers;for(const h in e.headers)s.set(h,e.headers[h]);return t}return{layerLoad:p,source:m,layerEmits:o}}});function ke(e,a,r,u,o,m){const d=_("Capabilities"),n=_("VaMediaLayer");return V(),g(n,Q({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},Y(e.layerEmits)),{default:S(()=>[L(d,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),O(e.$slots,"default")]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const x=W(be,[["render",ke]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const Ve="/test-api/layer/media",Ot=v({__name:"basic",setup(e){const a=J(q),u={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=K({url:Ve,layerName:"SSTD:D20240723-000052-P0",token:"8D626FD08BE249ADACEEF8990C8195F5EL47FBSWL3FAH11I"}),m=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{a.value=!0}}],d=async i=>{const c=i.view;await i.layer.when();const f=i.layer.capabilities.extent;console.log(f),await c.when(),f&&c.goTo(f)},n=ee(0),p=i=>{n.value=i.zoom},l=i=>{console.log(i.result?.element.get("id"))};return(i,c)=>(V(),g(y(ce),{"default-options":u},{before:S(()=>[N("p",null,[N("span",null,"当前缩放级别: "+te(n.value),1)]),L(y(fe),{"label-width":100,"form-items":m,data:o,onSetData:c[0]||(c[0]=f=>y(ye)(o,f))},null,8,["data"])]),default:S(()=>[L(y(de),{type:"vec_c","spatial-reference":{wkid:4490}}),y(a)?re("",!0):(V(),g(y(x),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},onLoad:d,onClick:l,onRequest:p},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Ot as default};

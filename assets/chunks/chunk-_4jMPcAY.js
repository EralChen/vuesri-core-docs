import{br as R,gY as C,hb as q,hd as M,lt as _,oC as j,gW as z,gZ as G,oG as P,dg as W,mI as H,hm as Q,lD as Y,h7 as O,g$ as E,h0 as S,h3 as B,h5 as v,lF as J,oE as K,tU as ee,h6 as te,h2 as ae,he as re,h9 as I,h1 as y,hi as ne}from"./chunk-fyrbxnSH.js";import{e as oe,u as se,V as ie,c as me}from"./chunk-eDJzKBSO.js";import{V as le,b as ue,u as pe}from"./chunk-4_iomi75.js";import{u as ce}from"./chunk-DnUVT2kT.js";import{R as de}from"./chunk-FEI8nmeL.js";import{V as fe}from"./chunk-dN6wQvTk.js";import"./chunk-HweOevSv.js";import"./chunk-J56G0tfX.js";import"./chunk-2GxOKeMR.js";import"./chunk-P9tUIRkp.js";import"./chunk-772XWEia.js";import"./chunk-YaJXmmBt.js";import"./chunk-UERyKPoA.js";import{V as ye}from"./chunk-O3wZbxMk.js";import"./chunk-vMx9XH42.js";import"./chunk-gQEVD-8d.js";import"./chunk-wEWeE-kh.js";import"./chunk-NW6e5t6_.js";import"./chunk-kd0F-y8E.js";import"./chunk-FFUT3eSU.js";import"./chunk-4trzkumg.js";import"./chunk-31jQ7dXp.js";import"./chunk-41oGK5L-.js";import"./chunk-z_tJDZ2S.js";import"./chunk-bWLF_K-H.js";import"./chunk--BQOcUZl.js";import"./chunk-CriDKu2f.js";import"./chunk-h0xo4hgW.js";import"./chunk-lBa4w8aQ.js";import"./chunk-Abi_Pjb2.js";import"./chunk-eDkG2VwT.js";import"./chunk-gURnCaT2.js";import"./chunk-BHIBmPKZ.js";import"./chunk-2NVTrInp.js";import"./chunk-WQeTsbj8.js";import"./chunk-2SniRbCX.js";import"./chunk-U-Nete6o.js";import"./chunk-ABuHt22V.js";import"./chunk-vAS8_wYl.js";import"./chunk-QAs2x3-K.js";import"./chunk-c_El_ySb.js";import"./chunk-Tfiywsvt.js";import{V as he,s as we}from"./chunk-dbjzebwm.js";import"./chunk-qn7jb9-b.js";import"./chunk-f83L__eB.js";import"./chunk-pxSSoWZz.js";import"./chunk-B3AFDltd.js";import"./chunk-Mx5yI2Yn.js";import"./chunk-0F1EjARU.js";import"./chunk-MTRZ_l68.js";import"./chunk-qsfsjFeh.js";import"./chunk-8B4vbrgS.js";import"./chunk-AS0MY0Bi.js";import"./chunk-s8pQThvl.js";import"./chunk-lD6t8LMi.js";import"./chunk-qi3bAG5m.js";import"./chunk-jnimAInW.js";import"./chunk-Cq8UfG38.js";import"./chunk-AQtzEpXZ.js";import"./chunk-T36RDINh.js";import"./chunk-Pj6ZoDcY.js";import"./chunk-G1YzTaQs.js";import"./chunk-19dCrj45.js";import"./chunk-PK6VYLyu.js";import"./chunk-_N6gej9z.js";import"./chunk-0HH7s1DD.js";import"./chunk-I0yzb-TT.js";const xe={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},Re={...oe,load:t=>t,request:t=>t};function N(t,n,a="id"){const l=[],i=n.reduce((p,m)=>{const o=m[a];return p.set(o,m),p},new Map),u=t.reduce((p,m)=>{const o=m[a];return i.has(o)?(l.push(m),i.delete(o)):p.set(o,m),p},new Map),d=[...i.values()],r=[...u.values()];return{addMap:i,deleteMap:u,updateRows:l,addRows:d,deleteRows:r}}const $=new de({baseURL:""}),ge=async(t,n,a={},l={})=>$.request({baseURL:t,method:"GET",url:"/elements",params:{SRS:"EPSG:"+n.BBOX.spatialReference.wkid,...n,BBOX:[n.BBOX.xmin,n.BBOX.ymin,n.BBOX.xmax,n.BBOX.ymax].join(","),...a},...l}),Ve=async(t,n,a={},l={})=>$.request({baseURL:t,method:"GET",url:"",params:{...n,...a},...l}),be=C({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(t){const n=t,a=se(),l=u(),i=a.when.bind(a);a.when=(...r)=>l.then(()=>i(...r));function u(){return Ve(n.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:n.layerName},n.customParameters,{setRequestInit:d}).then(r=>{r.extent&&(r.extent=new R(r.extent)),a.maxScale=r.maxScale,a.minScale=r.minScale,a.capabilities=r})}function d(r){const p=r.headers;for(const m in n.headers)p.set(m,n.headers[m]);return r}return(r,p)=>q(r.$slots,"default")}}),ke=C({name:"VaMediaTileLayer",components:{VaMediaLayer:ie,Capabilities:be},props:xe,emits:Re,setup(t,{emit:n}){const a=ce(),l=Math.random().toString(36).substring(2,9),i=me(n,["load"]),u=new le({elements:[]}),d=M(),r=M(),p=e=>{e.layer.when(()=>{d.value=e.layer}),e.layer.on("layerview-create",s=>{r.value=s.layerView}),P(()=>{n("load",e)})},m=e=>{r.value&&W(()=>!r.value?.updating).then(e)},o=new H,c=_({SERVICE:"ZZTS"}),f=()=>{c.LAYER=t.layerName,c.SCALE=a.scale;let e=a.extent;e&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(e=Q(a.extent));const s=e;s&&(c.BBOX=new R({xmin:s.xmin,ymin:s.ymin,xmax:s.xmax,ymax:s.ymax,spatialReference:{wkid:4326}})),c.HEIGHT=a.height,c.WIDTH=a.width},A=a.watch("stationary",e=>{e&&g()});o.add(A);const U=j(g,800),Z=a.on("drag",()=>{U()});o.add(Z),z(()=>{o.removeAll()});const L=_({zoom:0});function T(e){e.length!==0&&m(()=>u.elements.addMany(e))}function g(){a.when(()=>{f(),F()})}function F(){if(t.url)return ge(t.url,c,t.customParameters,{queue:{id:l,mode:"abort"},setRequestInit:D}).then(async e=>{n("request",e);const s=u.elements.toArray();let h=!1,V=[];e.zoom!==L.zoom&&(h=!0,V=s),L.zoom=e.zoom;const b=[];if(e.elements){for(const k of e.elements){const w=X(k);w&&b.push(w)}if(h)T(b);else{const{addRows:k,deleteRows:w}=N(s,b,"id");T(k),V=w}return V}}).then(e=>{setTimeout(()=>{if(!e)return;const{updateRows:s}=N(u.elements.toArray(),e,"id");s.length!==0&&(r.value?.updating||m(()=>u.elements.removeMany(s)))},400)}).catch(e=>{e.name!=="AbortError"&&console.error(e)})}G(()=>[t.url,t.layerName,t.customParameters,t.headers],()=>{g()},{immediate:!0,deep:!0});function X(e){if(e.type==="image"){const s=new ue({image:e.url,georeference:new pe({extent:{...e.extent,spatialReference:{wkid:4326}}})});return s.id=e.id,s}}function D(e){const s=e.headers;for(const h in t.headers)s.set(h,t.headers[h]);return e}return{layerLoad:p,source:u,layerEmits:i}}});function Ee(t,n,a,l,i,u){const d=O("Capabilities"),r=O("VaMediaLayer");return E(),S(r,J({source:t.source,onLoad:t.layerLoad},K(t.layerEmits)),{default:B(()=>[v(d,{url:t.url,"layer-name":t.layerName,headers:t.headers,"custom-parameters":t.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),q(t.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Y(ke,[["render",Ee]]);x.install=t=>{t.component(x.name||"VaMediaTileLayer",x)};const Se="/test-api/layer/media",At=C({__name:"basic",setup(t){const n=ee(P),l={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},i=te({url:Se,layerName:"SSTD:D20240606-000001-P0",token:"866E0318465B47C5B252F6F306EFA00EZ8ZX8VPJQIPF9POV"}),u=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{n.value=!0}}],d=async o=>{const c=o.view;await o.layer.when();const f=o.layer.capabilities.extent;console.log(f),await c.when(),f&&c.goTo(f)},r=ae(0),p=o=>{r.value=o.zoom},m=o=>{console.log(o.result?.element.get("id"))};return(o,c)=>(E(),S(y(fe),{"default-options":l},{before:B(()=>[I("p",null,[I("span",null,"当前缩放级别: "+re(r.value),1)]),v(y(he),{"label-width":100,"form-items":u,data:i,onSetData:c[0]||(c[0]=f=>y(we)(i,f))},null,8,["data"])]),default:B(()=>[v(y(ye),{type:"vec_c","spatial-reference":{wkid:4490}}),y(n)?ne("",!0):(E(),S(y(x),{key:0,url:i.url,"layer-name":i.layerName,"custom-parameters":{layerId:i.layerName,token:i.token},headers:{token:i.token},onLoad:d,onClick:m,onRequest:p},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{At as default};

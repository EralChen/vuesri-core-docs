import{cJ as R,gZ as L,hc as q,he as M,lu as _,gX as U,g_ as Z,oI as A,bL as j,lP as z,ho as G,lE as H,h8 as I,h0 as V,h1 as g,h4 as S,h6 as v,hi as W,oG as Q,tX as Y,h7 as J,h3 as K,hf as ee,ha as N,h2 as y,hk as te}from"./chunk-r79-UitW.js";import{e as re,u as ae,V as ne,c as oe}from"./chunk-JahouNFX.js";import{V as se,b as ie,u as me}from"./chunk-BrKYdqT0.js";import{u as le}from"./chunk-QlMQA5MY.js";import{R as ue}from"./chunk-FEI8nmeL.js";import{V as pe}from"./chunk-f-qDskxj.js";import"./chunk-QQWeD_ir.js";import"./chunk-c4b-Yaea.js";import"./chunk-EpNfzgt8.js";import"./chunk-GaQCtJAj.js";import"./chunk-iJFM8kcj.js";import"./chunk-MO7AtA6M.js";import"./chunk-A1k3Sw6V.js";import{V as ce}from"./chunk-HbTg3DvT.js";import"./chunk-woU6z8Ei.js";import"./chunk-CaitbKEY.js";import"./chunk-ioYUBtQg.js";import"./chunk-AIkMVrBB.js";import"./chunk-zPn7vAq8.js";import"./chunk-Nl6L5Sha.js";import"./chunk-XYcYaV54.js";import"./chunk-oiJm1HFG.js";import"./chunk-Ze2sBanE.js";import"./chunk-A-93cahJ.js";import"./chunk-i8Hri-Zk.js";import"./chunk-qSwNteA0.js";import"./chunk-wpULlYmq.js";import"./chunk-9hAMyKdI.js";import"./chunk-HHSX2f6G.js";import"./chunk-rzTdRPKU.js";import"./chunk-nGBmUvPo.js";import"./chunk-F6pmMbG8.js";import"./chunk-UcyyodeN.js";import"./chunk-AWcxOjZK.js";import"./chunk-vpjPN8w4.js";import"./chunk-8GNmAK67.js";import"./chunk-ozya2Jv4.js";import"./chunk-56-EE9ID.js";import"./chunk-v81I-D8v.js";import"./chunk-yfXX26rS.js";import"./chunk-Z_IYtaAq.js";import"./chunk-V9_cq-fp.js";import{V as de,s as fe}from"./chunk-1Scc6I4K.js";import"./chunk-FXkWrVKJ.js";import"./chunk-Qgrzwe6s.js";import"./chunk-X1l1T6Lo.js";import"./chunk-B3AFDltd.js";import"./chunk-NxD5GeLy.js";import"./chunk-XNej7aTS.js";import"./chunk-VeTFGOxM.js";import"./chunk-o7LZu4TO.js";import"./chunk-tqbIfa7W.js";import"./chunk-YB3NrSZj.js";import"./chunk-2MwrJuAD.js";import"./chunk-Y0Vu1B5E.js";import"./chunk-_In_pGH5.js";import"./chunk--xTsYuJy.js";import"./chunk-ENCxAf3G.js";import"./chunk-lYyaG9p-.js";import"./chunk-1e5GIKf6.js";import"./chunk-iXGO8X4T.js";import"./chunk-GpV4kBjA.js";import"./chunk-a475dYuM.js";import"./chunk-YPK7cZHF.js";import"./chunk-nl3wOKtS.js";import"./chunk-DH-o2pOi.js";const ye={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3}},he={...re,load:e=>e,request:e=>e};function O(e,r,a="id"){const u=[],o=r.reduce((p,l)=>{const i=l[a];return p.set(i,l),p},new Map),m=e.reduce((p,l)=>{const i=l[a];return o.has(i)?(u.push(l),o.delete(i)):p.set(i,l),p},new Map),d=[...o.values()],n=[...m.values()];return{addMap:o,deleteMap:m,updateRows:u,addRows:d,deleteRows:n}}const P=new ue({baseURL:""}),we=async(e,r,a={},u={})=>P.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...u}).then(o=>(o.elements.forEach(m=>{m.id=r.LAYER+"_"+m.id}),o)),xe=async(e,r,a={},u={})=>P.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...u}),Re=L({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=ae(),u=m(),o=a.when.bind(a);a.when=(...n)=>u.then(()=>o(...n));function m(){return xe(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent&&(n.extent=new R(n.extent)),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const p=n.headers;for(const l in r.headers)p.set(l,r.headers[l]);return n}return(n,p)=>q(n.$slots,"default")}}),Ee=L({name:"VaMediaTileLayer",components:{VaMediaLayer:ne,Capabilities:Re},props:ye,emits:he,setup(e,{emit:r}){const a=le(),u=Math.random().toString(36).substring(2,9),o=oe(r,["load"]),m=new se({elements:[]}),d=M(),n=M(),p=t=>{t.layer.when(()=>{d.value=t.layer}),t.layer.on("layerview-create",s=>{n.value=s.layerView}),A(()=>{r("load",t)})},l=t=>{n.value&&j(()=>!n.value?.updating).then(t)},i=new z,c=_({SERVICE:"ZZTS"}),f=()=>{c.LAYER=e.layerName,c.SCALE=a.scale;let t=a.extent;t&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=G(a.extent));const s=t;s&&(c.BBOX=new R({xmin:s.xmin,ymin:s.ymin,xmax:s.xmax,ymax:s.ymax,spatialReference:{wkid:4326}})),c.HEIGHT=a.height,c.WIDTH=a.width},$=a.watch("stationary",t=>{t&&C()});i.add($),U(()=>{i.removeAll()});const B=_({zoom:0});function T(t){t.length!==0&&l(()=>m.elements.addMany(t))}function C(){a.when(()=>{f(),D()})}function D(){if(e.url)return we(e.url,c,e.customParameters,{queue:{id:u,mode:"abort"},setRequestInit:F}).then(async t=>{r("request",t);const s=m.elements.toArray();let h=!1,E=[];t.zoom!==B.zoom&&(h=!0,E=s),B.zoom=t.zoom;const k=[];if(t.elements){for(const b of t.elements){const w=X(b);w&&k.push(w)}if(h)T(k);else{const{addRows:b,deleteRows:w}=O(s,k,"id");T(b),E=w}return E}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:s}=O(m.elements.toArray(),t,"id");s.length!==0&&(n.value?.updating||l(()=>m.elements.removeMany(s)))},400)}).catch(t=>{t.name!=="AbortError"&&console.error(t)})}Z(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{C()},{immediate:!0,deep:!0});function X(t){if(t.type==="image"){const s=new ie({image:t.url,georeference:new me({extent:{...t.extent,spatialReference:{wkid:4326}}})});return s.id=t.id,s}}function F(t){const s=t.headers;for(const h in e.headers)s.set(h,e.headers[h]);return t}return{layerLoad:p,source:m,layerEmits:o}}});function ke(e,r,a,u,o,m){const d=I("Capabilities"),n=I("VaMediaLayer");return V(),g(n,W({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},Q(e.layerEmits)),{default:S(()=>[v(d,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),q(e.$slots,"default")]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const x=H(Ee,[["render",ke]]);x.install=e=>{e.component(x.name||"VaMediaTileLayer",x)};const be="/test-api/layer/media",Ot=L({__name:"basic",setup(e){const r=Y(A),u={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=J({url:be,layerName:"SSTD:D20240723-000052-P0",token:"8D626FD08BE249ADACEEF8990C8195F5EL47FBSWL3FAH11I"}),m=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async i=>{const c=i.view;await i.layer.when();const f=i.layer.capabilities.extent;console.log(f),await c.when(),f&&c.goTo(f)},n=K(0),p=i=>{n.value=i.zoom},l=i=>{console.log(i.result?.element.get("id"))};return(i,c)=>(V(),g(y(pe),{"default-options":u},{before:S(()=>[N("p",null,[N("span",null,"当前缩放级别: "+ee(n.value),1)]),v(y(de),{"label-width":100,"form-items":m,data:o,onSetData:c[0]||(c[0]=f=>y(fe)(o,f))},null,8,["data"])]),default:S(()=>[v(y(ce),{type:"vec_c","spatial-reference":{wkid:4490}}),y(r)?te("",!0):(V(),g(y(x),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},onLoad:d,onClick:l,onRequest:p},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Ot as default};

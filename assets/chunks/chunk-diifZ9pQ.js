import{bM as R,bN as b,bO as k,bP as T,O as D,bQ as O,z,bR as G,bS as S,bT as L,bU as Q,bV as w,bW as h,bX as y,bA as P}from"./chunk-CMhy9c9G.js";const _="esri.widgets.Feature.support.featureUtils",g=()=>z.getLogger(_),H=/href=(""|'')/gi,V=/(\{([^{\r\n]+)\})/g,X=/'/g,j=/^\s*expression\//i,B=/(\n)/gi,J=/[\u00A0-\u9999<>&]/gim,K=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,W=/^(?:mailto:|tel:)/,E="relationships/",F=R("short-date-short-time");function Ne(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function Ze({type:e,value:t,event:n}){try{return typeof t=="function"?t(n):await t}catch(r){return void g().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function $e(e=""){if(e)return!W.test(e.trim().toLowerCase())}function Y(e){return!!e&&j.test(e)}function ee(e,t){if(!t||!Y(t)||!e)return;const n=t.replace(j,"").toLowerCase();return e.find(({name:r})=>r.toLowerCase()===n)}function Le(e,t){const n=ee(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function te(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function ne(e){return e.replaceAll(H,"")}function v(e,t){const n=I(t,e);return n?n.name:e}function je(e,t){return e&&e.map(n=>v(n,t))}function I(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function x(e){return`${e}`.trim()}function Ee({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:a,fieldInfoMap:i}){return r?re({formattedAttributes:t,template:ue(r,{...t,...a,...e},n),fieldInfoMap:i}):""}function re({formattedAttributes:e,template:t,fieldInfoMap:n}){return x(ne(b(b(t,r=>te(r,n)),e)))}function ie(e,t,n=!1){const r=t[e];if(typeof r=="string"){const a="%27",i=(n?encodeURIComponent(r):r).replaceAll(X,a);t[e]=i}}function ae(e,t=!1){const n={...e};return Object.keys(n).forEach(r=>ie(r,n,t)),n}function oe(e,t,n){const r=(t=x(t))&&t[0]!=="{";return b(e,ae(n,r||!1))}function le(e,t){return e.replaceAll(V,(n,r,a)=>{const i=I(t,a);return i?`{${i.name}}`:r})}function ue(e,t,n){const r=le(e,n);return r&&r.replaceAll(K,(a,i,o)=>oe(a,i||o,t))}function se(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const n=Number(e);if(!isNaN(n))return n}return e}function A(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function fe(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function ce(e){return!!(e&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"type"in e)&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function de(e){return A(e)&&fe(e)}function ve(e){return A(e)&&ce(e)}function pe(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:a,layer:i,timeZone:o}=t,s=me(n,r),u=I(i,r);if(s&&!w(r)){const f=u?.type,c=s.format?.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||c)return L(e,{format:c,fieldType:f,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:o,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}})}const l=s?.format;return typeof e=="string"&&w(r)&&l?ye(e,l):typeof(e=se(e,l))=="string"||e==null||l==null?C(e):h(e,a?{...y(l),minimumFractionDigits:0,maximumFractionDigits:20}:y(l))}function ye(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?m(e,",",", ",t):e.includes(";")?m(e,";","; ",t):e.includes(" ")?m(e," "," ",t):h(Number(e),y(t))}function m(e,t,n,r){return e.trim().split(t).map(a=>h(Number(a),y(r))).join(n)}function me(e,t){if(e?.length&&t)return e.find(n=>n.fieldName?.toLowerCase()===t.toLowerCase())}function be({fieldName:e,graphic:t,layer:n}){if(M(e)||!n||typeof n.getFeatureType!="function")return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const a=n.getFeatureType(t);return a?a.name:null}function ge({fieldName:e,value:t,graphic:n,layer:r}){if(M(e)||!r||typeof r.getFieldDomain!="function")return null;const a=n&&r.getFieldDomain(e,{feature:n,excludeImpliedDomains:P("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function xe(e,t,n,r){const{creatorField:a,creationDateField:i,editorField:o,editDateField:s}=e;if(!t)return;const u=k(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,n,F,"date"),l={...F,...u},f=t[s];if(typeof f=="number"){const d=t[o];return{type:"edit",date:T(f,l),user:d}}const c=t[i];if(typeof c=="number"){const d=t[a];return{type:"create",date:T(c,l),user:d}}return null}function Ae(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const a=v(r.fieldName,t);r.fieldName=a,n.set(a.toLowerCase(),r)}return n}function Ce(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)&&r.forEach(a=>{if(a.type==="fields"){const i=a?.fieldInfos;i&&t.push(...i)}}),t}function qe(e){return e.replaceAll(J,t=>`&#${t.charCodeAt(0)};`)}function C(e){return typeof e=="string"?e.replaceAll(B,'<br class="esri-text-new-line" />'):e}function q(e){const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:a,layer:i,graphic:o,timeZone:s}=e;if(t==null)return"";const u=ge({fieldName:n,value:t,graphic:o,layer:i});if(u)return u;const l=be({fieldName:n,graphic:o,layer:i});if(l)return l;if(a.get(n.toLowerCase()))return pe(t,{fieldInfos:r||Array.from(a.values()),fieldName:n,layer:i,timeZone:s});const f=i?.fieldsIndex?.get(n);return f&&(G(f)||S(f))?L(t,{fieldType:f.type,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}}):C(t)}function Me({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:a,relatedInfos:i,timeZone:o}){const s={};return i?.forEach(u=>we({attributes:s,relatedInfo:u,fieldInfoMap:a,fieldInfos:e,layer:n,timeZone:o})),t&&Object.keys(t).forEach(u=>{const l=t[u];s[u]=q({fieldName:u,fieldInfos:e,fieldInfoMap:a,layer:n,value:l,graphic:r,timeZone:o})}),s}async function he(e,t){const{layer:n,graphic:r,outFields:a,objectIds:i,returnGeometry:o,spatialReference:s}=e,u=i[0];if(typeof u!="number"&&typeof u!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",c={layer:n,graphic:r,objectId:u,requiredFields:a};return g().warn(f,c),null}if(!D(n)?.operations?.supportsQuery){const f="The specified layer cannot be queried. The following fields will not be available.",c={layer:n,graphic:r,requiredFields:a,returnGeometry:o};return g().warn(f,c),null}const l=n.createQuery();return l.objectIds=i,l.outFields=a?.length?a:[n.objectIdField],l.returnGeometry=!!o,l.returnZ=!!o,l.returnM=!!o,l.outSpatialReference=s,(await n.queryFeatures(l,t)).features[0]}async function Ie(e){if(!e.expressionInfos?.length)return!1;const t=await Q(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function Ue({graphic:e,popupTemplate:t,layer:n,spatialReference:r},a){if(!n||!t||(typeof n.load=="function"&&await n.load(a),!e.attributes))return;const i=n.objectIdField,o=e.attributes[i];if(o==null)return;const s=[o],u=await t.getRequiredFields(n.fieldsIndex),l=O(u,e),f=l?[]:u.includes(i)?u:[...u,i],c=t.returnGeometry||await Ie(t);if(l&&!c)return;const d=await he({layer:n,graphic:e,outFields:f,objectIds:s,returnGeometry:c,spatialReference:r},a);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function M(e=""){return!!e&&e.includes(E)}function Te(e){return e?`${E}${e.layerId}/${e.fieldName}`:""}function N({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:a,layer:i,timeZone:o}){e&&t&&n&&Object.keys(t.attributes).forEach(s=>{const u=Te({layerId:n.relation.id.toString(),fieldName:s}),l=t.attributes[s];e[u]=q({fieldName:u,fieldInfos:r,fieldInfoMap:a,layer:i,value:l,graphic:t,timeZone:o})})}function we({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i}){e&&t&&(t.relatedFeatures?.forEach(o=>N({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i})),t.relatedStatsFeatures?.forEach(o=>N({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i})))}const Z=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},U=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||t==="attachments")return;const a=n.where!=null?n.where:null,i=n.geometry!=null?n.geometry:null;Z(r)||Z(a)||i?.type==="extent"||n.resultType==="tile"||(n.cacheHint=!0)},Re=({query:e,layer:t,method:n})=>{U({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},ke=({queryPayload:e,layer:t,method:n})=>{U({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function De(e,t,n){return e&&t&&n?t.type==="sublayer"?p({layers:t.layer?.sublayers,map:e,relatedLayer:t,relationship:n})||p({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:n}):p({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||p({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function Oe(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(n=>n.isUtilityLayer(t)):null}function $(e,t){return e?.allTables.find(n=>n.type==="feature"&&n.layerId===t.id&&n.url===t.layer?.url)}function p({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:a}){if(!a)return null;for(const i of a){if(i.type==="map-image"){const s=p({layers:i.sublayers,map:e,relatedLayer:r,relationship:t})||p({layers:i.subtables,map:e,relatedLayer:r,relationship:t});if(s)return s;continue}if(!de(i))continue;if(r.type==="sublayer"){if(i!==r&&i.id===n)return i.isTable?$(e,i):i;continue}const o=r.type==="scene"&&r.associatedLayer?r.associatedLayer.url:r.url;if(!o)return null;if(i.type!=="sublayer"){if(i!==r&&i.url===o&&i.layerId===n)return i}else if(i!==r&&i.layer?.url===o&&i.id===n)return i.isTable?$(e,i):i}return null}function ze(e){const t=e.getObjectId();return t!=null?`oid:${t}`:`uid:${e.uid}`}export{Ee as D,Ze as E,De as F,de as K,ze as L,v as M,Oe as N,le as Q,je as R,Re as T,Le as U,ve as V,Ne as a,Ce as b,he as c,Me as f,xe as i,qe as l,Ae as o,Ue as p,me as t,C as u,$e as v,ke as w,Y as x,M as y,re as z};

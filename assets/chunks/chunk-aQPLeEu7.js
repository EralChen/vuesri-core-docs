import{uN as H,cL as h,g$ as B,he as $,hg as N,uO as W,lB as _,g_ as F,h0 as Q,p1 as z,b$ as Y,lv as J,hq as K,E as q,ad as ee,a6 as te,lL as re,ha as E,h2 as g,h3 as S,h6 as L,h7 as P,hm as A,hk as ae,o$ as oe,uP as ie,h9 as ne,h5 as se,hc as I,hh as me,h4 as w}from"./chunk-YzRi88Dj.js";import{e as le,u as pe,V as ue,c as ce}from"./chunk-CWuugisY.js";import{V as de,b as ye,u as fe}from"./chunk-BjlDaQPD.js";import{u as he}from"./chunk-mQ0J7OJ8.js";import{R as we}from"./chunk-zKPkODU6.js";import{V as xe}from"./chunk-Dsi4UQrI.js";import{V as Re}from"./chunk-DZ3w8ZOu.js";import"./chunk-BX1wMDvx.js";import"./chunk-DlgRifwZ.js";import"./chunk-MXvXirnR.js";import"./chunk-Clcwg9Qm.js";import"./chunk-CVnttSzt.js";import"./chunk-BlTBh7Wn.js";import"./chunk-DltoMSe1.js";import"./chunk-C9tqeO9j.js";import"./chunk-BkUj7kCJ.js";import"./chunk-lA_W8v3a.js";import"./chunk-CheEsZui.js";import"./chunk-CLQIQQkk.js";import"./chunk-CD3FIDfI.js";import"./chunk-DjXdGIkr.js";import"./chunk-BeMirVWN.js";import"./chunk-CtOsnhEP.js";import"./chunk-D83kxBTm.js";import"./chunk-CMTIf1CS.js";import"./chunk-DhQzXLKM.js";import"./chunk-Dw_nTs4K.js";import"./chunk-FEB8T15a.js";import"./chunk-BRnY4uVr.js";import"./chunk--uKKWstj.js";import"./chunk-Bv-gq04m.js";import"./chunk-DNuFRK75.js";import"./chunk-BBWE_Ghm.js";import"./chunk-CpRg--ys.js";import"./chunk-CvEYJb1U.js";import"./chunk-CyteEnia.js";import"./chunk-DunbwQDX.js";import"./chunk-CFGc4D18.js";import"./chunk-CfNfXr3t.js";import"./chunk-B40jiAhY.js";import"./chunk-BwNtFsQb.js";import"./chunk-BVXbP2w4.js";import{V as ge,s as Se}from"./chunk-SyfkAsIp.js";import"./chunk-DjOIj6-o.js";import"./chunk-ByM7454y.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-BHw4eVQu.js";import"./chunk-DHvBO4SR.js";import"./chunk-BCOlSIf9.js";import"./chunk-Ch0SDxT-.js";import"./chunk-Da7lMuRe.js";import"./chunk-CFLxDY7g.js";import"./chunk-BKo6erB9.js";import"./chunk-BFPp9v7s.js";import"./chunk-2BMjRaDU.js";import"./chunk-DkJbD3YB.js";import"./chunk-B7IxsrlQ.js";/* empty css              */import"./chunk-D1eaHFcV.js";import"./chunk-CzH9YP0J.js";import"./chunk-BJmFAILw.js";import"./chunk-CurIDYYZ.js";import"./chunk-CuewZUm5.js";import"./chunk-BxGO9xbL.js";/* empty css              */import"./chunk-BZo4aBej.js";/* empty css              *//* empty css              */import"./chunk-D4KI0uoT.js";import"./chunk-Bw6A12Vg.js";import"./chunk-DGYRbKE9.js";import"./chunk-c5sFaa6D.js";import"./chunk-_SCJxduo.js";var be=0;function O(e){var r=++be;return H(e)+r}const ke={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new h({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3},showGeoSlot:{type:Boolean,default:!1}},Ve={...le,load:e=>e,request:e=>e};function G(e,r,a="id"){const p=[],o=r.reduce((m,l)=>{const s=l[a];return m.set(s,l),m},new Map),u=e.reduce((m,l)=>{const s=l[a];return o.has(s)?(p.push(l),o.delete(s)):m.set(s,l),m},new Map),c=[...o.values()],n=[...u.values()];return{addMap:o,deleteMap:u,updateRows:p,addRows:c,deleteRows:n}}const D=new we({baseURL:""}),ve=async(e,r,a={},p={})=>D.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...p}).then(o=>(o.elements.forEach(u=>{u.id=r.LAYER+"_"+u.id}),o)),Ee=async(e,r,a={},p={})=>D.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...p}),Le=B({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=pe(),p=u(),o=a.when.bind(a);a.when=(...n)=>p.then(()=>o(...n));function u(){return Ee(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:c}).then(n=>{n.extent&&(n.extent=new h(n.extent)),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n,a.capabilitiesResponse=n})}function c(n){const m=n.headers;for(const l in r.headers)m.set(l,r.headers[l]);return n}return(n,m)=>$(n.$slots,"default")}}),Be=B({name:"VaMediaTileLayer",components:{VaMediaLayer:ue,Capabilities:Le,VaGraphicsLayer:xe},props:ke,emits:Ve,setup(e,{emit:r}){const a=he(),p=ce(r,["load"]),o=new de({elements:[]}),u=N(),c=W(),n=t=>{t.layer.when(()=>{u.value=t.layer}),t.layer.on("layerview-create",i=>{c.resolve(i.layerView)}),z(()=>{r("load",t)})},m=async t=>{const i=await c.promise;Y(()=>!i.updating).then(t)},l=new J,s=_({SERVICE:"ZZTS"}),y=()=>{s.LAYER=e.layerName,s.SCALE=a.scale;let t=a.extent;t&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=K(a.extent));const i=t;i&&(s.BBOX=new h({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}})),s.HEIGHT=a.height,s.WIDTH=a.width},f=a.watch("stationary",t=>{t&&M()});l.add(f),F(()=>{l.removeAll()});const T=_({zoom:0});function C(t){t.length!==0&&m(()=>o.elements.addMany(t))}function M(){y(),Z()}Q(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{M()},{immediate:!0,deep:!0});function U(t){if(t.type==="image"){const i=new ye({image:t.url,georeference:new fe({extent:{...t.extent,spatialReference:{wkid:4326}}})});return i.id=t.id,i}}function j(t){const i=t.headers;for(const d in e.headers)i.set(d,e.headers[d]);return t}const b=N([]),X=t=>{b.value=[];const i=[];t.forEach(d=>{i.push(new q({geometry:new h({...d.extent,spatialReference:{wkid:4326}}).center,attributes:{id:O()},symbol:new ee({text:d.id.split("_")[1],color:"red",font:{size:12,weight:"bold"}})})),i.push(new q({geometry:new h({...d.extent,spatialReference:{wkid:4326}}),attributes:{id:O()},symbol:new te({color:[255,0,0,0],outline:{color:[255,0,0,1],width:1}})}))}),b.value=i};function Z(){if(e.url)return ve(e.url,s,e.customParameters,{queue:{id:e.layerName,mode:"wait"},setRequestInit:j}).then(async t=>{r("request",t);const i=o.elements.toArray();let d=!1,k=[];t.zoom!==T.zoom&&(d=!0,k=i),T.zoom=t.zoom;const V=[];if(t.elements){e.showGeoSlot&&X(t.elements);for(const v of t.elements){const x=U(v);x&&V.push(x)}if(d)C(V);else{const{addRows:v,deleteRows:x}=G(i,V,"id");C(v),k=x}return k}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:i}=G(o.elements.toArray(),t,"id");i.length!==0&&(c.value?.updating||m(()=>o.elements.removeMany(i)))},400)}).catch(t=>{console.error(t)})}return{layerLoad:n,source:o,layerEmits:p,geoslotSource:b}}});function Te(e,r,a,p,o,u){const c=E("Capabilities"),n=E("VaGraphicsLayer"),m=E("VaMediaLayer");return g(),S(m,ae({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},oe(e.layerEmits)),{default:L(()=>[P(c,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),$(e.$slots,"default"),e.showGeoSlot?(g(),S(n,{key:0,graphics:e.geoslotSource},null,8,["graphics"])):A("",!0)]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const R=re(Be,[["render",Te]]);R.install=e=>{e.component(R.name||"VaMediaTileLayer",R)};const Ce="http://t1.zjsophon.com:10000/zz/zz-mapServer/proxy/mapServer/layer/media",Lr=B({__name:"basic",setup(e){const r=ie(z),p={center:new h({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=ne({url:Ce,layerName:"SSTD:D20240822-000259-P0",token:"ce6373e184cf2df93f486e03a8189cb7"}),u=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],c=async s=>{const y=s.view;await s.layer.when();const f=s.layer.capabilities.extent;console.log(f),await y.when(),f&&y.goTo(f)},n=se(0),m=s=>{n.value=s.zoom},l=s=>{console.log(s.result?.element.get("id"))};return(s,y)=>(g(),S(w(Re),{"default-options":p},{before:L(()=>[I("p",null,[I("span",null,"当前缩放级别: "+me(n.value),1)]),P(w(ge),{"label-width":100,"form-items":u,data:o,onSetData:y[0]||(y[0]=f=>w(Se)(o,f))},null,8,["data"])]),default:L(()=>[w(r)?A("",!0):(g(),S(w(R),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},"show-geo-slot":!0,onLoad:c,onClick:l,onRequest:m},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Lr as default};

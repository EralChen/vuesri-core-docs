import{br as R,gY as v,hb as N,hd as M,lt as _,oC as j,gW as z,oG as P,dg as G,mI as W,hm as H,lD as Q,h7 as O,g$ as b,h0 as E,h3 as S,h5 as B,lF as Y,oE as J,tU as K,h6 as ee,h2 as te,he as ae,h9 as I,h1 as f,hi as re}from"./chunk-fyrbxnSH.js";import{e as ne,u as oe,V as se,c as ie}from"./chunk-eDJzKBSO.js";import{V as me,b as le,u as pe}from"./chunk-4_iomi75.js";import{u as ue}from"./chunk-DnUVT2kT.js";import{R as ce}from"./chunk-FEI8nmeL.js";import{V as de}from"./chunk-dN6wQvTk.js";import"./chunk-HweOevSv.js";import"./chunk-J56G0tfX.js";import"./chunk-2GxOKeMR.js";import"./chunk-P9tUIRkp.js";import"./chunk-772XWEia.js";import"./chunk-YaJXmmBt.js";import"./chunk-UERyKPoA.js";import{V as fe}from"./chunk-O3wZbxMk.js";import"./chunk-vMx9XH42.js";import"./chunk-gQEVD-8d.js";import"./chunk-wEWeE-kh.js";import"./chunk-NW6e5t6_.js";import"./chunk-kd0F-y8E.js";import"./chunk-FFUT3eSU.js";import"./chunk-4trzkumg.js";import"./chunk-31jQ7dXp.js";import"./chunk-41oGK5L-.js";import"./chunk-z_tJDZ2S.js";import"./chunk-bWLF_K-H.js";import"./chunk--BQOcUZl.js";import"./chunk-CriDKu2f.js";import"./chunk-h0xo4hgW.js";import"./chunk-lBa4w8aQ.js";import"./chunk-Abi_Pjb2.js";import"./chunk-eDkG2VwT.js";import"./chunk-gURnCaT2.js";import"./chunk-BHIBmPKZ.js";import"./chunk-2NVTrInp.js";import"./chunk-WQeTsbj8.js";import"./chunk-2SniRbCX.js";import"./chunk-U-Nete6o.js";import"./chunk-ABuHt22V.js";import"./chunk-vAS8_wYl.js";import"./chunk-9Bl8Fb0Y.js";import"./chunk-c_El_ySb.js";import"./chunk-Tfiywsvt.js";import{V as ye,s as he}from"./chunk-Jym8TJbY.js";import"./chunk-qn7jb9-b.js";import"./chunk-f83L__eB.js";import"./chunk-pxSSoWZz.js";import"./chunk-B3AFDltd.js";import"./chunk-Mx5yI2Yn.js";import"./chunk-0F1EjARU.js";import"./chunk-MTRZ_l68.js";import"./chunk-qsfsjFeh.js";import"./chunk-8B4vbrgS.js";import"./chunk-AS0MY0Bi.js";import"./chunk-s8pQThvl.js";import"./chunk-lD6t8LMi.js";import"./chunk-qi3bAG5m.js";import"./chunk-jnimAInW.js";import"./chunk-Cq8UfG38.js";import"./chunk-AQtzEpXZ.js";import"./chunk-T36RDINh.js";import"./chunk-Pj6ZoDcY.js";import"./chunk-G1YzTaQs.js";import"./chunk-19dCrj45.js";import"./chunk-PK6VYLyu.js";import"./chunk-_N6gej9z.js";import"./chunk-0HH7s1DD.js";import"./chunk-u8xdCC6Y.js";const we={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new R({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})}},xe={...ne,load:t=>t,request:t=>t};function q(t,r,a="id"){const l=[],s=r.reduce((u,m)=>{const o=m[a];return u.set(o,m),u},new Map),p=t.reduce((u,m)=>{const o=m[a];return s.has(o)?(l.push(m),s.delete(o)):u.set(o,m),u},new Map),d=[...s.values()],n=[...p.values()];return{addMap:s,deleteMap:p,updateRows:l,addRows:d,deleteRows:n}}const $=new ce({baseURL:""}),Re=async(t,r,a={},l={})=>$.request({baseURL:t,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...l}),Ve=async(t,r,a={},l={})=>$.request({baseURL:t,method:"GET",url:"",params:{...r,...a},...l}),ge=v({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(t){const r=t,a=oe(),l=p(),s=a.when.bind(a);a.when=(...n)=>l.then(()=>s(...n));function p(){return Ve(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:d}).then(n=>{n.extent=new R(n.extent),a.maxScale=n.maxScale,a.minScale=n.minScale,a.capabilities=n})}function d(n){const u=n.headers;for(const m in r.headers)u.set(m,r.headers[m]);return n}return(n,u)=>N(n.$slots,"default")}}),ke=v({name:"VaMediaTileLayer",components:{VaMediaLayer:se,Capabilities:ge},props:we,emits:xe,setup(t,{emit:r}){const a=ue(),l=Math.random().toString(36).substring(2,9),s=ie(r,["load"]),p=new me({elements:[]}),d=M(),n=M(),u=e=>{e.layer.when(()=>{d.value=e.layer}),e.layer.on("layerview-create",i=>{n.value=i.layerView}),P(()=>{r("load",e)})},m=e=>{n.value&&G(()=>!n.value?.updating).then(e)},o=new W,c=_({SERVICE:"ZZTS"}),y=()=>{c.LAYER=t.layerName,c.SCALE=a.scale;let e=a.extent;(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(e=H(a.extent));const i=e;c.BBOX=new R({xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax,spatialReference:{wkid:4326}}),c.HEIGHT=a.height,c.WIDTH=a.width},U=a.watch("stationary",e=>{e&&T()});o.add(U);const A=j(T,800),F=a.on("drag",()=>{A()});o.add(F),z(()=>{o.removeAll()});const C=_({zoom:0});function L(e){e.length!==0&&m(()=>p.elements.addMany(e))}function T(){y(),X()}function X(){if(t.url)return Re(t.url,c,t.customParameters,{queue:{id:l,mode:"abort"},setRequestInit:D}).then(async e=>{r("request",e);const i=p.elements.toArray();let h=!1,V=[];e.zoom!==C.zoom&&(h=!0,V=i),C.zoom=e.zoom;const g=[];if(e.elements){for(const k of e.elements){const w=Z(k);w&&g.push(w)}if(h)L(g);else{const{addRows:k,deleteRows:w}=q(i,g,"id");L(k),V=w}return V}}).then(e=>{setTimeout(()=>{if(!e)return;const{updateRows:i}=q(p.elements.toArray(),e,"id");i.length!==0&&(n.value?.updating||m(()=>p.elements.removeMany(i)))},400)})}function Z(e){if(e.type==="image"){const i=new le({image:e.url,georeference:new pe({extent:{...e.extent,spatialReference:{wkid:4326}}})});return i.id=e.id,i}}function D(e){const i=e.headers;for(const h in t.headers)i.set(h,t.headers[h]);return e}return{layerLoad:u,source:p,layerEmits:s}}});function be(t,r,a,l,s,p){const d=O("Capabilities"),n=O("VaMediaLayer");return b(),E(n,Y({source:t.source,onLoad:t.layerLoad},J(t.layerEmits)),{default:S(()=>[B(d,{url:t.url,"layer-name":t.layerName,headers:t.headers,"custom-parameters":t.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),N(t.$slots,"default")]),_:3},16,["source","onLoad"])}const x=Q(ke,[["render",be]]);x.install=t=>{t.component(x.name||"VaMediaTileLayer",x)};const Ee="/test-api/layer/media",$t=v({__name:"basic",setup(t){const r=K(P),l={center:new R({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},s=ee({url:Ee,layerName:"SSTD:D20240606-000001-P0",token:"866E0318465B47C5B252F6F306EFA00EZ8ZX8VPJQIPF9POV"}),p=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],d=async o=>{const c=o.view;await o.layer.when();const y=o.layer.capabilities.extent;await c.when(),c.goTo(y)},n=te(0),u=o=>{n.value=o.zoom},m=o=>{console.log(o.result?.element.get("id"))};return(o,c)=>(b(),E(f(de),{"default-options":l},{before:S(()=>[I("p",null,[I("span",null,"当前缩放级别: "+ae(n.value),1)]),B(f(ye),{"label-width":100,"form-items":p,data:s,onSetData:c[0]||(c[0]=y=>f(he)(s,y))},null,8,["data"])]),default:S(()=>[B(f(fe),{type:"vec_c","spatial-reference":{wkid:4490}}),f(r)?re("",!0):(b(),E(f(x),{key:0,url:s.url,"layer-name":s.layerName,"custom-parameters":{layerId:s.layerName,token:s.token},headers:{token:s.token},onLoad:d,onClick:m,onRequest:u},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{$t as default};

import{uv as H,cJ as h,gZ as B,hc as z,he as _,uw as W,lB as N,gX as F,g_ as Q,oI as $,bL as Y,lr as J,ho as K,C as I,ab as ee,a4 as te,lH as re,h8 as E,h0 as g,h1 as b,h4 as L,h6 as P,hk as A,hi as ae,oG as oe,ux as ne,h7 as se,h3 as ie,hf as le,ha as G,h2 as w}from"./chunk-fHrNL0KE.js";import{e as me,u as ue,V as ce,c as pe}from"./chunk-9Xm3mQLQ.js";import{V as de,b as ye,u as fe}from"./chunk-kyamY1C6.js";import{u as he}from"./chunk-oihAJXyJ.js";import{R as we}from"./chunk-YAzdkTjJ.js";import{V as xe}from"./chunk-QxXwI5R8.js";import{V as Re}from"./chunk-DxdXOgnz.js";import"./chunk-aaF08RLl.js";import"./chunk-CJ93w3lF.js";import"./chunk-5sZ8cOm7.js";import"./chunk-qU9ug55b.js";import"./chunk-696gQ_0Y.js";import"./chunk-Gh-YYW1u.js";import"./chunk-dh53Jslg.js";import"./chunk-V7wMI-M1.js";import"./chunk-7WQT7ntw.js";import"./chunk--fAu8HIB.js";import"./chunk-ADeLpH6z.js";import"./chunk-PEmjdORh.js";import"./chunk-udydY4-Q.js";import"./chunk-lUz6pzTx.js";import"./chunk-OtrhsN3k.js";import"./chunk-hwxJk16m.js";import"./chunk-MdcONs9d.js";import"./chunk-webAJys3.js";import"./chunk-Zdebg6g9.js";import"./chunk-UM8yAOgJ.js";import"./chunk-BZyJvBwR.js";import"./chunk-Or-nAgsa.js";import"./chunk-XfrNqGsj.js";import"./chunk-DhGbJNcI.js";import"./chunk-Nw9qefak.js";import"./chunk-k8skosWR.js";import"./chunk-0R7WeF7L.js";import"./chunk-nIGC-Ax6.js";import"./chunk-F9gjVU-T.js";import"./chunk-oBZYJIeq.js";import"./chunk-PtKCC_GV.js";import"./chunk-oP0o3Nh4.js";import"./chunk-khhwXIoB.js";import"./chunk-2fioQh0W.js";import"./chunk-xKJ-Rb1Q.js";import{V as ge,s as be}from"./chunk-CUdjq8cQ.js";import"./chunk-vMCO_d3L.js";import"./chunk-0wTVHGNT.js";import"./chunk-I0Ze1Lq5.js";import"./chunk-B3AFDltd.js";import"./chunk-M9hnJ_t7.js";import"./chunk-Mv08grWe.js";import"./chunk-QKkDBMz0.js";import"./chunk-zZAfPfBR.js";import"./chunk-0k55eIfB.js";import"./chunk-iRHYTMro.js";import"./chunk-3foBDDFQ.js";import"./chunk-iirWKWKr.js";import"./chunk-FBiO-tOz.js";import"./chunk-H5gP66cR.js";import"./chunk-SQSdfN4Z.js";import"./chunk-UD1v1y82.js";import"./chunk-_hO8gbVC.js";import"./chunk-uJuxWpDx.js";import"./chunk-igw9NDGA.js";import"./chunk-O_wbTWft.js";import"./chunk-YrgFVyC-.js";import"./chunk-nMNkS3c7.js";var Se=0;function q(e){var r=++Se;return H(e)+r}const ke={url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})},fullExtent:{type:Object,default:()=>new h({xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}})},retryTimes:{type:Number,default:5},retryInterval:{type:Number,default:1e3},showGeoSlot:{type:Boolean,default:!1}},Ve={...me,load:e=>e,request:e=>e};function O(e,r,a="id"){const u=[],o=r.reduce((l,m)=>{const i=m[a];return l.set(i,m),l},new Map),c=e.reduce((l,m)=>{const i=m[a];return o.has(i)?(u.push(m),o.delete(i)):l.set(i,m),l},new Map),p=[...o.values()],s=[...c.values()];return{addMap:o,deleteMap:c,updateRows:u,addRows:p,deleteRows:s}}const D=new we({baseURL:""}),ve=async(e,r,a={},u={})=>D.request({baseURL:e,method:"GET",url:"/elements",params:{SRS:"EPSG:"+r.BBOX.spatialReference.wkid,...r,BBOX:[r.BBOX.xmin,r.BBOX.ymin,r.BBOX.xmax,r.BBOX.ymax].join(","),...a},...u}).then(o=>(o.elements.forEach(c=>{c.id=r.LAYER+"_"+c.id}),o)),Ee=async(e,r,a={},u={})=>D.request({baseURL:e,method:"GET",url:"",params:{...r,...a},...u}),Le=B({__name:"capabilities",props:{url:{type:String,required:!0},layerName:{type:String,required:!0},headers:{type:Object,default:()=>({})},customParameters:{type:Object,default:()=>({})}},setup(e){const r=e,a=ue(),u=c(),o=a.when.bind(a);a.when=(...s)=>u.then(()=>o(...s));function c(){return Ee(r.url,{SERVICE:"ZZTS",REQUEST:"GetCapabilities",LAYER:r.layerName},r.customParameters,{setRequestInit:p}).then(s=>{s.extent&&(s.extent=new h(s.extent)),a.maxScale=s.maxScale,a.minScale=s.minScale,a.capabilities=s,a.capabilitiesResponse=s})}function p(s){const l=s.headers;for(const m in r.headers)l.set(m,r.headers[m]);return s}return(s,l)=>z(s.$slots,"default")}}),Be=B({name:"VaMediaTileLayer",components:{VaMediaLayer:ce,Capabilities:Le,VaGraphicsLayer:xe},props:ke,emits:Ve,setup(e,{emit:r}){const a=he(),u=pe(r,["load"]),o=new de({elements:[]}),c=_(),p=W(),s=t=>{t.layer.when(()=>{c.value=t.layer}),t.layer.on("layerview-create",n=>{p.resolve(n.layerView)}),$(()=>{r("load",t)})},l=async t=>{const n=await p.promise;Y(()=>!n.updating).then(t)},m=new J,i=N({SERVICE:"ZZTS"}),y=()=>{i.LAYER=e.layerName,i.SCALE=a.scale;let t=a.extent;t&&(a.extent.spatialReference.wkid===102100||a.extent.spatialReference.wkid===3857)&&(t=K(a.extent));const n=t;n&&(i.BBOX=new h({xmin:n.xmin,ymin:n.ymin,xmax:n.xmax,ymax:n.ymax,spatialReference:{wkid:4326}})),i.HEIGHT=a.height,i.WIDTH=a.width},f=a.watch("stationary",t=>{t&&M()});m.add(f),F(()=>{m.removeAll()});const T=N({zoom:0});function C(t){t.length!==0&&l(()=>o.elements.addMany(t))}function M(){y(),Z()}Q(()=>[e.url,e.layerName,e.customParameters,e.headers],()=>{M()},{immediate:!0,deep:!0});function U(t){if(t.type==="image"){const n=new ye({image:t.url,georeference:new fe({extent:{...t.extent,spatialReference:{wkid:4326}}})});return n.id=t.id,n}}function X(t){const n=t.headers;for(const d in e.headers)n.set(d,e.headers[d]);return t}const S=_([]),j=t=>{S.value=[];const n=[];t.forEach(d=>{n.push(new I({geometry:new h({...d.extent,spatialReference:{wkid:4326}}).center,attributes:{id:q()},symbol:new ee({text:d.id.split("_")[1],color:"red",font:{size:12,weight:"bold"}})})),n.push(new I({geometry:new h({...d.extent,spatialReference:{wkid:4326}}),attributes:{id:q()},symbol:new te({color:[255,0,0,0],outline:{color:[255,0,0,1],width:1}})}))}),S.value=n};function Z(){if(e.url)return ve(e.url,i,e.customParameters,{queue:{id:e.layerName,mode:"wait"},setRequestInit:X}).then(async t=>{r("request",t);const n=o.elements.toArray();let d=!1,k=[];t.zoom!==T.zoom&&(d=!0,k=n),T.zoom=t.zoom;const V=[];if(t.elements){e.showGeoSlot&&j(t.elements);for(const v of t.elements){const x=U(v);x&&V.push(x)}if(d)C(V);else{const{addRows:v,deleteRows:x}=O(n,V,"id");C(v),k=x}return k}}).then(t=>{setTimeout(()=>{if(!t)return;const{updateRows:n}=O(o.elements.toArray(),t,"id");n.length!==0&&(p.value?.updating||l(()=>o.elements.removeMany(n)))},400)}).catch(t=>{console.error(t)})}return{layerLoad:s,source:o,layerEmits:u,geoslotSource:S}}});function Te(e,r,a,u,o,c){const p=E("Capabilities"),s=E("VaGraphicsLayer"),l=E("VaMediaLayer");return g(),b(l,ae({source:e.source,"retry-times":e.retryTimes,"retry-interval":e.retryInterval,onLoad:e.layerLoad},oe(e.layerEmits)),{default:L(()=>[P(p,{url:e.url,"layer-name":e.layerName,headers:e.headers,"custom-parameters":e.customParameters},null,8,["url","layer-name","headers","custom-parameters"]),z(e.$slots,"default"),e.showGeoSlot?(g(),b(s,{key:0,graphics:e.geoslotSource},null,8,["graphics"])):A("",!0)]),_:3},16,["source","retry-times","retry-interval","onLoad"])}const R=re(Be,[["render",Te]]);R.install=e=>{e.component(R.name||"VaMediaTileLayer",R)};const Ce="http://t1.zjsophon.com:10000/zz/zz-mapServer/proxy/mapServer/layer/media",Dt=B({__name:"basic",setup(e){const r=ne($),u={center:new h({xmax:122.742924043633,xmin:117.96922121524364,ymax:30.869274740242954,ymin:28.400118104869154,spatialReference:{wkid:4326}}).center,scale:614500},o=se({url:Ce,layerName:"SSTD:D20240822-000259-P0",token:"ce6373e184cf2df93f486e03a8189cb7"}),c=[{templateType:"VkfInput",prop:"url",label:"url"},{templateType:"VkfInput",prop:"layerName",label:"layerName"},{templateType:"VkfInput",prop:"token",label:"token"},{templateType:"VkfButton",buttonLabel:"更新",type:"primary",onClick:()=>{r.value=!0}}],p=async i=>{const y=i.view;await i.layer.when();const f=i.layer.capabilities.extent;console.log(f),await y.when(),f&&y.goTo(f)},s=ie(0),l=i=>{s.value=i.zoom},m=i=>{console.log(i.result?.element.get("id"))};return(i,y)=>(g(),b(w(Re),{"default-options":u},{before:L(()=>[G("p",null,[G("span",null,"当前缩放级别: "+le(s.value),1)]),P(w(ge),{"label-width":100,"form-items":c,data:o,onSetData:y[0]||(y[0]=f=>w(be)(o,f))},null,8,["data"])]),default:L(()=>[w(r)?A("",!0):(g(),b(w(R),{key:0,url:o.url,"layer-name":o.layerName,"custom-parameters":{layerId:o.layerName,token:o.token},headers:{token:o.token},"show-geo-slot":!0,onLoad:p,onClick:m,onRequest:l},null,8,["url","layer-name","custom-parameters","headers"]))]),_:1}))}});export{Dt as default};
